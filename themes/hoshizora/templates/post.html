{% extends "base.html" %}

{% block title %}{{ post.title }} - {{ site_title or 'Noteblog' }}{% endblock %}
{% block description %}{{ post.excerpt or post.content[:150] }}{% endblock %}
{% set liked_posts = session.get('liked_posts', []) if session is defined else [] %}
{% set liked_comments = session.get('liked_comments', []) if session is defined else [] %}

{% block hero %}
<section class="hoshi-hero" style="margin-top:1.5rem;">
    <div class="hoshi-hero-left">
        <span class="hoshi-hero-tag">{{ post.category.name if post.category else 'POST' }}</span>
        <h1 class="hoshi-hero-title">{{ post.title }}</h1>
        <p class="hoshi-hero-desc">å‘å¸ƒäº {{ (post.published_at or post.created_at)|localtime('%Y-%m-%d') if post.created_at else '' }}</p>
        <div class="hoshi-hero-actions">
            <button class="hoshi-pill-btn primary" type="button" data-hoshi-like-post data-post-id="{{ post.id }}" data-liked="{{ 'true' if post.id in liked_posts else 'false' }}">
                å–œæ¬¢ Â· <span data-like-count>{{ post.like_count or 0 }}</span>
            </button>
            <a class="hoshi-pill-btn secondary" href="#comments">è·³åˆ°è¯„è®º</a>
        </div>
    </div>
    <div class="hoshi-hero-right">
        <div class="hoshi-chibi-card">
            <div class="avatar">âœ¦</div>
            <h4>{{ post.author.display_name or post.author.username }}</h4>
            <p>{{ post.author.bio or '' }}</p>
            <div class="hoshi-chibi-tags">
                <span>ğŸ‘€ {{ post.view_count or 0 }}</span>
                {% if post.comment_count is not none %}
                <span>ğŸ’¬ {{ post.comment_count }}</span>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<article class="hoshi-card hoshi-article">
    <header class="hoshi-post-header">
        <div class="hoshi-post-meta">
            <span class="hoshi-meta-pill">{{ post.category.name if post.category else 'POST' }}</span>
            <span>{{ (post.published_at or post.created_at)|localtime('%Y-%m-%d') if post.created_at else '' }}</span>
            {% if post.category %}
            <span>Â· <a href="/category/{{ post.category.slug }}">{{ post.category.name }}</a></span>
            {% endif %}
            <span>Â· by {{ post.author.display_name or post.author.username }}</span>
        </div>
        {% if post.tags %}
        <div class="hoshi-tag-row" style="margin-top:0.75rem;">
            {% for tag in post.tags %}
            <a class="hoshi-tag-pill" href="/tag/{{ tag.slug }}">#{{ tag.name }}</a>
            {% endfor %}
        </div>
        {% endif %}
        {% if plugin_hooks and plugin_hooks.post_meta %}
            {% for hook in plugin_hooks.post_meta %}
                {{ hook|safe }}
            {% endfor %}
        {% endif %}
    </header>

    {% if post.featured_image %}
    <figure class="hoshi-post-cover" style="margin-bottom:1.5rem;">
        <img src="{{ post.featured_image }}" alt="{{ post.title }}" loading="lazy">
    </figure>
    {% endif %}

    <div class="hoshi-article">
        {{ post.get_content_html()|safe }}
    </div>

    <footer class="hoshi-card-footer" style="margin-top:2rem;">
        <!-- group three compact actions in one row: copy / share (mailto) / like -->
        <div class="hoshi-footer-actions">
            <button class="hoshi-pill-btn secondary hoshi-footer-btn" type="button" data-hoshi-copy title="{{ request.url }}">
                <span class="hoshi-copy-icon" aria-hidden="true">ğŸ“‹</span>
                <span class="hoshi-copy-text" title="{{ request.url }}">{{ request.url }}</span>
            </button>

            <a class="hoshi-pill-btn hoshi-footer-btn secondary" href="mailto:?subject={{ post.title }}&body={{ request.url }}" title="åˆ†äº«é‚®ä»¶">âœ‰ï¸ åˆ†äº«</a>

            <button class="hoshi-pill-btn hoshi-footer-btn hoshi-like-btn" type="button" data-hoshi-like-post data-post-id="{{ post.id }}" data-liked="{{ 'true' if post.id in liked_posts else 'false' }}">
                <span aria-hidden="true">â¤</span>
                <span class="hoshi-like-text">å–œæ¬¢ Â· <span data-like-count>{{ post.like_count or 0 }}</span></span>
            </button>
        </div>
    </footer>

    {% if plugin_hooks and plugin_hooks.post_footer %}
        {% for hook in plugin_hooks.post_footer %}
            {{ hook|safe }}
        {% endfor %}
    {% endif %}
</article>

{% if prev_post or next_post %}
<nav class="hoshi-card" style="display:flex;flex-wrap:wrap;gap:1rem;justify-content:space-between;">
    {% if prev_post %}
    <a href="/post/{{ prev_post.slug }}" class="hoshi-link-card" style="flex:1;text-decoration:none;color:inherit;">
        <strong>â† ä¸Šä¸€ç¯‡</strong>
        <p>{{ prev_post.title }}</p>
    </a>
    {% endif %}
    {% if next_post %}
    <a href="/post/{{ next_post.slug }}" class="hoshi-link-card" style="flex:1;text-decoration:none;color:inherit;text-align:right;">
        <strong>ä¸‹ä¸€ç¯‡ â†’</strong>
        <p>{{ next_post.title }}</p>
    </a>
    {% endif %}
</nav>
{% endif %}

<section class="hoshi-card" id="comments">
    {% set total_comments = post.comment_count if post.comment_count is not none else (comments|length if comments else 0) %}
    <header class="hoshi-post-header">
        <span class="hoshi-meta-pill">Comments</span>
        <h2 class="hoshi-post-title">è¯„è®º Â· {{ total_comments }}</h2>
    </header>

    {% if post.comment_status == 'open' and allow_comments %}
    {% if plugin_hooks and plugin_hooks.comment_form_top %}
        {% for hook in plugin_hooks.comment_form_top %}
            {{ hook|safe }}
        {% endfor %}
    {% endif %}
    <form class="hoshi-comment-form" data-post-id="{{ post.id }}">
        <input type="hidden" name="post_id" value="{{ post.id }}">
        <input type="hidden" name="parent_id" value="">
        <div class="hoshi-comment-reply" data-reply-indicator hidden>
            æ­£åœ¨å›å¤ <strong data-reply-name></strong>
            <button type="button" class="hoshi-ghost-btn" data-cancel-reply>å–æ¶ˆ</button>
        </div>
        {% if not current_user.is_authenticated %}
        <div class="hoshi-comment-grid">
            <label>æ˜µç§°
                <input class="hoshi-input" type="text" name="author_name" required>
            </label>
            <label>é‚®ç®±
                <input class="hoshi-input" type="email" name="author_email" required>
            </label>
            <label>ç½‘ç«™
                <input class="hoshi-input" type="url" name="author_website" placeholder="https://example.com">
            </label>
        </div>
        {% endif %}
        <label>å†…å®¹
            <textarea class="hoshi-input" name="content" rows="4" required placeholder="å‹å–„å‘è¨€ï¼Œæ”¯æŒ Markdown"></textarea>
        </label>
        <div class="hoshi-card-footer" style="justify-content:flex-end;">
            <button class="hoshi-pill-btn primary" type="submit">æäº¤è¯„è®º</button>
        </div>
    </form>
    {% if plugin_hooks and plugin_hooks.comment_form_bottom %}
        {% for hook in plugin_hooks.comment_form_bottom %}
            {{ hook|safe }}
        {% endfor %}
    {% endif %}
    {% else %}
    <div class="hoshi-empty">è¯„è®ºå·²å…³é—­ã€‚</div>
    {% endif %}

    <div class="hoshi-comments-list">
        {% if comments %}
        <ol class="hoshi-comment-items">
            {% for comment in comments %}
            {% set display = comment.get_display_name() %}
            <li class="hoshi-comment-item" data-comment-id="{{ comment.id }}">
                <div class="hoshi-comment-avatar">
                    {% if comment.get_display_avatar() %}
                    <img src="{{ comment.get_display_avatar() }}" alt="{{ display }}">
                    {% else %}
                    <span>{{ display[:1].upper() if display else 'è®¿' }}</span>
                    {% endif %}
                </div>
                <div class="hoshi-comment-body">
                    <div class="hoshi-comment-head">
                        <strong>{{ display }}</strong>
                        <time>{{ comment.created_at|localtime('%Y-%m-%d %H:%M') if comment.created_at else '' }}</time>
                        {% if comment.get_display_website() %}
                        <a href="{{ comment.get_display_website() }}" target="_blank" rel="noopener">ğŸ”—</a>
                        {% endif %}
                    </div>
                    <div class="hoshi-comment-text">{{ comment.get_content_html()|safe }}</div>
                    <div class="hoshi-comment-actions">
                        {% if post.comment_status == 'open' and allow_comments %}
                        <button type="button" class="hoshi-ghost-btn" data-hoshi-reply data-comment-id="{{ comment.id }}" data-author="{{ display }}">å›å¤</button>
                        {% endif %}
                        <button type="button" class="hoshi-ghost-btn" data-hoshi-comment-like data-comment-id="{{ comment.id }}" data-liked="{{ 'true' if comment.id in liked_comments else 'false' }}">
                            èµ Â· <span data-like-count>{{ comment.like_count or 0 }}</span>
                        </button>
                    </div>
                    {% set replies = comment.get_replies() %}
                    {% if replies %}
                    <ol class="hoshi-comment-children">
                        {% for reply in replies %}
                        {% set reply_name = reply.get_display_name() %}
                        <li class="hoshi-comment-item" data-comment-id="{{ reply.id }}">
                            <div class="hoshi-comment-avatar">
                                {% if reply.get_display_avatar() %}
                                <img src="{{ reply.get_display_avatar() }}" alt="{{ reply_name }}">
                                {% else %}
                                <span>{{ reply_name[:1].upper() if reply_name else 'è®¿' }}</span>
                                {% endif %}
                            </div>
                            <div class="hoshi-comment-body">
                                <div class="hoshi-comment-head">
                                    <strong>{{ reply_name }}</strong>
                                    <time>{{ reply.created_at|localtime('%Y-%m-%d %H:%M') if reply.created_at else '' }}</time>
                                </div>
                                <div class="hoshi-comment-text">
                                    {% if display %}<span class="mention">@{{ display }}</span>{% endif %}
                                    {{ reply.get_content_html()|safe }}
                                </div>
                                <div class="hoshi-comment-actions">
                                    {% if post.comment_status == 'open' and allow_comments %}
                                    <button type="button" class="hoshi-ghost-btn" data-hoshi-reply data-comment-id="{{ reply.id }}" data-author="{{ reply_name }}">å›å¤</button>
                                    {% endif %}
                                    <button type="button" class="hoshi-ghost-btn" data-hoshi-comment-like data-comment-id="{{ reply.id }}" data-liked="{{ 'true' if reply.id in liked_comments else 'false' }}">
                                        èµ Â· <span data-like-count>{{ reply.like_count or 0 }}</span>
                                    </button>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ol>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ol>
        {% else %}
        <div class="hoshi-empty">è¿˜æ²¡æœ‰è¯„è®ºï¼Œæ¥å½“ç¬¬ä¸€ä¸ªå§ã€‚</div>
        {% endif %}
    </div>
</section>
{% endblock %}
