{% set _theme = get_theme_config() %}
{% set _default_mode = _theme.default_mode or 'light' %}
{% set _default_avatar = '/themes/hoshizora/static/images/avatar.svg' %}
<!DOCTYPE html>
<html lang="zh-CN" data-theme="{{ _default_mode }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ page_title or (site_title or 'Noteblog') }}{% endblock %}</title>
    <meta name="description" content="{% block description %}{{ site_description or page_description or '' }}{% endblock %}">
    <meta name="keywords" content="{% block keywords %}{{ site_keywords or '' }}{% endblock %}">

    {% if _theme.site_favicon %}
    <link rel="icon" type="image/png" href="{{ _theme.site_favicon }}">
    {% endif %}

    <link rel="stylesheet" href="/themes/hoshizora/static/css/hoshizora.css">
    {% if _theme.enable_math != false %}
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    {% endif %}

    <style>
        :root {
            --hoshi-primary: {{ _theme.primary_color or '#8d6bff' }};
            --hoshi-secondary: {{ _theme.secondary_color or '#ff8bd5' }};
            --hoshi-accent: {{ _theme.accent_color or '#6ff4ff' }};
        }
        body.hoshizora-body {
            background: linear-gradient({{ _theme.gradient_direction or '120deg' }}, rgba(17, 12, 32, 0.95), rgba(9, 9, 17, 0.98));
        }
        {% if _theme.background_texture == 'grid' %}
        .hoshi-bg::before,
        .hoshi-bg::after {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 30h60M30 0v60' stroke='%23ffffff' stroke-opacity='0.08' /%3E%3C/svg%3E");
        }
        {% elif _theme.background_texture == 'waves' %}
        .hoshi-bg::before,
        .hoshi-bg::after {
            background-image: url("data:image/svg+xml,%3Csvg width='320' height='180' viewBox='0 0 320 180' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 90 C60 120 120 60 180 90 C240 120 300 60 360 90' stroke='%23ffffff' stroke-opacity='0.07' fill='none' stroke-width='8'/%3E%3C/svg%3E");
        }
        {% elif _theme.background_texture == 'none' %}
        .hoshi-bg::before,
        .hoshi-bg::after {
            background: none;
        }
        {% endif %}
    </style>

    {% block head %}{% endblock %}

    {% if plugin_hooks and plugin_hooks.head_assets %}
        {% for asset in plugin_hooks.head_assets %}
            {{ asset|safe }}
        {% endfor %}
    {% endif %}
</head>
<body class="hoshizora-body" data-default-mode="{{ _default_mode }}" data-parallax="{{ 'true' if _theme.enable_parallax != false else 'false' }}" data-particles="{{ 'true' if _theme.enable_particle_field != false else 'false' }}">
    {% if _theme.enable_scroll_indicator != false %}
    <div class="hoshi-reading-progress" data-hoshi-progress>
        <span></span>
    </div>
    {% endif %}
    <div class="hoshi-bg"></div>
    {% if _theme.enable_particle_field != false %}
    <canvas class="hoshi-particles" data-hoshi-particles></canvas>
    {% endif %}
    <div class="hoshi-noise"></div>
    <div class="hoshi-aurora" aria-hidden="true">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div class="hoshi-orbs" aria-hidden="true">
        <span class="hoshi-orb orb-one"></span>
        <span class="hoshi-orb orb-two"></span>
        <span class="hoshi-orb orb-three"></span>
    </div>

    <div class="hoshi-app">
        <header class="hoshi-header">
            <div class="hoshi-header-inner">
                <div class="hoshi-brand">
                    <a href="/" class="hoshi-logo">
                        {% if _theme.site_logo %}
                            <img src="{{ _theme.site_logo }}" alt="{{ site_title or 'Noteblog' }}">
                        {% endif %}
                        <span>{{ site_title or 'Noteblog' }}</span>
                    </a>
                </div>
                <button class="hoshi-icon-btn hoshi-mobile-toggle" type="button" aria-label="åˆ‡æ¢å¯¼èˆª" data-hoshi-nav-toggle>â˜°</button>
                <nav class="hoshi-nav" data-hoshi-nav>
                    <a href="/" class="{% if request.path == '/' %}active{% endif %}">é¦–é¡µ</a>
                    <a href="/archives" class="{% if request.path.startswith('/archives') %}active{% endif %}">å½’æ¡£</a>
                    <a href="/categories" class="{% if request.path.startswith('/categories') %}active{% endif %}">åˆ†ç±»</a>
                    <a href="/tags" class="{% if request.path.startswith('/tags') %}active{% endif %}">æ ‡ç­¾</a>
                    <a href="/search" class="{% if request.path.startswith('/search') %}active{% endif %}">æœç´¢</a>
                    {% if plugin_hooks and plugin_hooks.nav %}
                        {% for hook in plugin_hooks.nav %}
                            {{ hook|safe }}
                        {% endfor %}
                    {% endif %}
                </nav>
                <div class="hoshi-actions">
                    <button class="hoshi-icon-btn" type="button" title="æœç´¢" data-hoshi-search>
                        ğŸ”
                    </button>
                    {% if _theme.enable_dark_mode_toggle != false %}
                    <button class="hoshi-icon-btn" type="button" title="åˆ‡æ¢ä¸»é¢˜" data-hoshi-theme>
                        â˜¯
                    </button>
                    {% endif %}
                    {% if current_user.is_authenticated %}
                        <details class="hoshi-user-chip">
                            <summary>
                                <span class="hoshi-user-initial">{{ (current_user.display_name or current_user.username)[:1].upper() }}</span>
                                <span class="hoshi-user-name">{{ current_user.display_name or current_user.username }}</span>
                            </summary>
                            <div class="hoshi-user-menu">
                                <a href="/auth/profile">ä¸ªäººèµ„æ–™</a>
                                <a href="javascript:void(0)" data-hoshi-modal-trigger="edit_profile">ç¼–è¾‘èµ„æ–™</a>
                                <a href="javascript:void(0)" data-hoshi-modal-trigger="change_password">ä¿®æ”¹å¯†ç </a>
                                {% if current_user.is_admin %}
                                <a href="/admin">ç®¡ç†åå°</a>
                                {% endif %}
                                <a href="/auth/logout">é€€å‡ºç™»å½•</a>
                            </div>
                        </details>
                    {% else %}
                        <button class="hoshi-ghost-btn" type="button" data-hoshi-auth-toggle="login">ç™»å½•</button>
                    {% endif %}
                </div>
            </div>
        </header>

        {# hero feature data removed #}
        {% block hero %}
        <section class="hoshi-hero">
            <div class="hoshi-hero-visual">
                <div class="hoshi-hero-orbit orbit-one"></div>
                <div class="hoshi-hero-orbit orbit-two"></div>
                <div class="hoshi-hero-orbit orbit-three"></div>
                <div class="hoshi-hero-glow"></div>
                <div class="hoshi-hero-core">
                    <span>{{ (_theme.hero_character_name or site_title or 'Noteblog')[:1] }}</span>
                </div>
                <div class="hoshi-hero-constellation">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="hoshi-hero-content">
                <p class="hoshi-hero-sup">{{ _theme.hero_subtitle or 'æ˜Ÿè¾°ç»½æ”¾ Â· æ¢¦æƒ³å¯èˆª' }}</p>
                <h2 class="hoshi-hero-title">{{ _theme.hero_character_name or site_title or 'Noteblog' }}</h2>
                <p class="hoshi-hero-desc">{{ _theme.hero_tagline or site_description or 'æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢ï¼Œè¿™é‡Œè®°å½•çµæ„Ÿä¸ä»£ç çš„å…‰è¾‰ç¬é—´ã€‚' }}</p>
                <div class="hoshi-hero-actions">
                    <a class="hoshi-pill-btn primary" href="{{ _theme.hero_cta_link or '/archives' }}">{{ _theme.hero_cta_text or 'æŸ¥çœ‹æ–‡ç« ' }}</a>
                    <a class="hoshi-pill-btn secondary" href="{{ _theme.hero_cta_secondary_link or '/about' }}">{{ _theme.hero_cta_secondary_text or 'äº†è§£æ›´å¤š' }}</a>
                </div>
                <div class="hoshi-hero-meta">
                    <span>{{ _theme.hero_meta_line_1 or 'æ˜Ÿè½¨ç¼–ç»‡ Â· æ»´ç­”å…‰å½±' }}</span>
                    <span>{{ _theme.hero_meta_line_2 or 'æ¯æ—¥æ›´æ–° Â· ç²¾å¿ƒæ‰“ç£¨' }}</span>
                </div>
            </div>
        </section>
        {# feature grid removed as requested #}
        {% endblock %}

        <main class="hoshi-main">
            <div class="hoshi-container">
                {% with flashes = get_flashed_messages(with_categories=true) %}
                    {% if flashes %}
                    <div class="hoshi-flashes">
                        {% for category, message in flashes %}
                        <div class="hoshi-flash hoshi-flash-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                {% endwith %}

                <div class="hoshi-layout {% if _theme.show_sidebar == false or _admin_page %}no-sidebar{% endif %}">
                    <section class="hoshi-content">
                        {% if plugin_hooks and plugin_hooks.content_top %}
                            {% for block in plugin_hooks.content_top %}
                                {{ block|safe }}
                            {% endfor %}
                        {% endif %}

                        {% block content %}{% endblock %}

                        {% if plugin_hooks and plugin_hooks.content_bottom %}
                            {% for block in plugin_hooks.content_bottom %}
                                {{ block|safe }}
                            {% endfor %}
                        {% endif %}
                    </section>

                    {% if _theme.show_sidebar != false and not _admin_page %}
                    <aside class="hoshi-sidebar">
                        {% block sidebar %}
                        <div class="hoshi-widget hoshi-profile-card">
                            <img src="{{ _theme.site_logo or _default_avatar }}" alt="{{ site_title }}">
                            <h3>{{ site_title or 'Noteblog' }}</h3>
                            <p>{{ site_description or 'æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢' }}</p>
                        </div>
                        <div class="hoshi-widget">
                            <h4 class="hoshi-widget-title">æœ€æ–°å‘è¡¨</h4>
                            <ul class="hoshi-list">
                                {% for post in (recent_posts|default([]))[:5] %}
                                <li><a href="/post/{{ post.slug }}"><span>{{ post.title }}</span><small>â†’</small></a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="hoshi-widget">
                            <h4 class="hoshi-widget-title">åˆ†ç±»</h4>
                            <div class="hoshi-tag-cloud">
                                {% for category in categories|default([]) %}
                                <a class="hoshi-tag-pill" href="/category/{{ category.slug }}">{{ category.name }} Â· {{ category.post_count or 0 }}</a>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="hoshi-widget">
                            <h4 class="hoshi-widget-title">æ ‡ç­¾</h4>
                            <div class="hoshi-tag-cloud">
                                {% for tag in tags|default([]) %}
                                <a class="hoshi-tag-pill" href="/tag/{{ tag.slug }}">#{{ tag.name }}</a>
                                {% endfor %}
                            </div>
                        </div>
                        {% if plugin_hooks and plugin_hooks.sidebar_bottom %}
                            {% for block in plugin_hooks.sidebar_bottom %}
                                {{ block|safe }}
                            {% endfor %}
                        {% endif %}
                        {% endblock %}
                    </aside>
                    {% endif %}
                </div>
            </div>
        </main>

        <footer class="hoshi-footer">
            {{ get_setting('footer_text', '<p>Â© 2025 Powered by Noteblog</p><p><a href=\"https://github.com/streetartist/noteblog\" target=\"_blank\" rel=\"noopener\">Noteblog</a> Â· Theme Hoshizora</p>')|safe }}
            {% if plugin_hooks and plugin_hooks.footer %}
                {% for block in plugin_hooks.footer %}
                    {{ block|safe }}
                {% endfor %}
            {% endif %}
        </footer>
    </div>

    <button class="hoshi-backtotop" type="button" aria-label="å›åˆ°é¡¶éƒ¨" data-hoshi-backtotop>â†Ÿ</button>

    <div class="hoshi-search-overlay" data-hoshi-search-overlay>
        <div class="hoshi-search-box">
            <form action="/search" method="GET">
                <input type="text" name="q" placeholder="è¾“å…¥å…³é”®è¯..." autocomplete="off">
                <button type="submit">æœç´¢</button>
                <button type="button" class="hoshi-icon-btn" aria-label="å…³é—­" data-hoshi-search-close>Ã—</button>
            </form>
        </div>
    </div>

    {% include 'auth/login.html' %}

    {% if current_user.is_authenticated %}
    <div class="hoshi-modal" data-hoshi-modal="edit_profile" aria-hidden="true">
        <div class="hoshi-modal-card">
            <header class="hoshi-modal-header">
                <div>
                    <p class="hoshi-modal-label">Profile</p>
                    <h3>ç¼–è¾‘èµ„æ–™</h3>
                </div>
                <button type="button" class="hoshi-icon-btn" aria-label="å…³é—­" data-hoshi-modal-close>Ã—</button>
            </header>
            <form action="{{ url_for('auth.edit_profile') }}" method="POST" enctype="multipart/form-data">
                <label>æ˜¾ç¤ºåç§°
                    <input class="hoshi-input" type="text" name="display_name" value="{{ current_user.display_name or current_user.username }}" autofocus>
                </label>
                <label>é‚®ç®±
                    <input class="hoshi-input" type="email" name="email" value="{{ current_user.email or '' }}">
                </label>
                <label>ä¸ªäººç½‘ç«™
                    <input class="hoshi-input" type="url" name="website" value="{{ current_user.website or '' }}" placeholder="https://example.com">
                </label>
                <label>æ‰€åœ¨åœ°
                    <input class="hoshi-input" type="text" name="location" value="{{ current_user.location or '' }}">
                </label>
                <label>ç®€ä»‹
                    <textarea class="hoshi-input" name="bio" rows="3">{{ current_user.bio or '' }}</textarea>
                </label>
                <label>å¤´åƒ
                    <input class="hoshi-input" type="file" name="avatar" accept="image/png,image/jpeg,image/webp">
                </label>
                <div class="hoshi-modal-actions">
                    <button type="button" class="hoshi-ghost-btn" data-hoshi-modal-close>å–æ¶ˆ</button>
                    <button type="submit" class="hoshi-pill-btn primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div class="hoshi-modal" data-hoshi-modal="change_password" aria-hidden="true">
        <div class="hoshi-modal-card">
            <header class="hoshi-modal-header">
                <div>
                    <p class="hoshi-modal-label">Security</p>
                    <h3>ä¿®æ”¹å¯†ç </h3>
                </div>
                <button type="button" class="hoshi-icon-btn" aria-label="å…³é—­" data-hoshi-modal-close>Ã—</button>
            </header>
            <form action="{{ url_for('auth.change_password') }}" method="POST" data-hoshi-change-password-form>
                <label>å½“å‰å¯†ç 
                    <input class="hoshi-input" type="password" name="current_password" autocomplete="current-password" required autofocus>
                </label>
                <label>æ–°å¯†ç 
                    <input class="hoshi-input" type="password" name="new_password" minlength="6" autocomplete="new-password" required>
                </label>
                <label>ç¡®è®¤æ–°å¯†ç 
                    <input class="hoshi-input" type="password" name="confirm_password" minlength="6" autocomplete="new-password" required>
                </label>
                <div class="hoshi-password-meter" data-hoshi-password-meter>
                    <div class="hoshi-password-meter-bar" data-hoshi-password-bar></div>
                    <span data-hoshi-password-label>å¼ºåº¦ï¼š-</span>
                </div>
                <p class="hoshi-password-hint" data-hoshi-password-match></p>
                <div class="hoshi-modal-actions">
                    <button type="button" class="hoshi-ghost-btn" data-hoshi-modal-close>å–æ¶ˆ</button>
                    <button type="submit" class="hoshi-pill-btn primary">ä¿®æ”¹å¯†ç </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <script src="/themes/hoshizora/static/js/hoshizora.js" defer></script>
    <script>
    (function() {
        function formatDate(date, format) {
            var pad = function(n) { return n < 10 ? '0' + n : n; };
            var map = {
                '%Y': date.getFullYear(),
                '%m': pad(date.getMonth() + 1),
                '%d': pad(date.getDate()),
                '%H': pad(date.getHours()),
                '%M': pad(date.getMinutes()),
                '%S': pad(date.getSeconds())
            };
            var result = format;
            for (var key in map) {
                result = result.replace(key, map[key]);
            }
            return result;
        }
        function convertToLocalTime() {
            document.querySelectorAll('time[data-localtime]').forEach(function(el) {
                var utcTime = el.getAttribute('datetime');
                if (!utcTime) return;
                try {
                    var date = new Date(utcTime);
                    if (isNaN(date.getTime())) return;
                    var format = el.getAttribute('data-format') || '%Y-%m-%d %H:%M:%S';
                    el.textContent = formatDate(date, format);
                    el.removeAttribute('data-localtime');
                } catch (e) {}
            });
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', convertToLocalTime);
        } else {
            convertToLocalTime();
        }
        window.addEventListener('hoshizora:content-updated', convertToLocalTime);
    })();
    </script>
    {% if _theme.enable_math != false %}
    <script src="https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script>
        (function () {
            const options = {
                delimiters: [
                    { left: '$$', right: '$$', display: true },
                    { left: '$', right: '$', display: false },
                    { left: '\\[', right: '\\]', display: true },
                    { left: '\\(', right: '\\)', display: false }
                ],
                throwOnError: false
            };

            function render(target) {
                if (!window.renderMathInElement) {
                    return;
                }
                window.renderMathInElement(target || document.body, options);
            }

            document.addEventListener('DOMContentLoaded', function () {
                render(document.querySelector('.hoshi-main') || document.body);
            });

            window.addEventListener('hoshizora:content-updated', function (event) {
                const root = event.detail && event.detail.root ? event.detail.root : document.querySelector('.hoshi-main') || document.body;
                render(root);
            });

            window.hoshiRenderMath = render;
        })();
    </script>
    {% endif %}

    {% if plugin_hooks and plugin_hooks.scripts_assets %}
        {% for asset_content in plugin_hooks.scripts_assets %}
            {{ asset_content|safe }}
        {% endfor %}
    {% endif %}

    {% if plugin_hooks and plugin_hooks.body_end %}
        {% for block in plugin_hooks.body_end %}
            {{ block|safe }}
        {% endfor %}
    {% endif %}

    {% if _theme.analytics_code %}
        {{ _theme.analytics_code|safe }}
    {% endif %}
</body>
</html>
