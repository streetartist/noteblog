{% extends "base.html" %}

{% block title %}æœç´¢{% if query %} - {{ query }}{% endif %} - {{ site_title or 'Noteblog' }}{% endblock %}

{% block content %}
<section class="serenity-search">
    <header class="search-header">
        <h1>æœç´¢æ–‡ç« </h1>
        <p>è¾“å…¥å…³é”®è¯ï¼ŒSerenity ä¼šå³æ—¶è¿”å›åŒ¹é…å†…å®¹ã€‚</p>
    </header>
    <form class="search-bar" action="/search" method="GET">
        <input type="text" name="q" placeholder="ä¾‹å¦‚ï¼šPythonã€æ—…è¡Œã€å‘¨æŠ¥..." value="{{ query or '' }}" autofocus>
        <button type="submit">æœç´¢</button>
    </form>

    {% if query %}
    <div class="search-status">
        <span>å…³é”®è¯ï¼š<strong>{{ query }}</strong></span>
        {% if posts and posts.total %}
        <span>æ‰¾åˆ° {{ posts.total }} æ¡ç»“æœ</span>
        {% endif %}
    </div>
    {% endif %}

    {% if query and posts and posts.items %}
    <div class="search-results">
        {% for post in posts.items %}
        <article class="search-card">
            <div class="search-card-head">
                <time>{{ post.published_at.strftime('%Y-%m-%d') if post.published_at else post.created_at.strftime('%Y-%m-%d') }}</time>
                {% if post.category %}
                <a href="/category/{{ post.category.slug }}">{{ post.category.name }}</a>
                {% endif %}
            </div>
            <h2><a href="/post/{{ post.slug }}">{{ post.title }}</a></h2>
            <div class="search-card-meta">ä½œè€… Â· {{ post.author.display_name or post.author.username }}</div>
            <div class="search-card-excerpt">{{ post.get_excerpt_html(200)|safe }}</div>
            {% if post.tags %}
            <div class="post-tags">
                {% for tag in post.tags[:5] %}
                <a class="tag-pill" href="/tag/{{ tag.slug }}">{{ tag.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </article>
        {% endfor %}
    </div>

    {% if posts.pages > 1 %}
    <nav class="serenity-pagination">
        {% if posts.has_prev %}
        <a class="pagination-btn" href="{{ url_for('main.search', q=query, page=posts.prev_num) }}">ä¸Šä¸€é¡µ</a>
        {% endif %}
        <span>ç¬¬ {{ posts.page }} / {{ posts.pages }} é¡µ</span>
        {% if posts.has_next %}
        <a class="pagination-btn" href="{{ url_for('main.search', q=query, page=posts.next_num) }}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </nav>
    {% endif %}
    {% elif query %}
    <div class="empty-state">
        <p>ğŸ”</p>
        <h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…ç»“æœ</h3>
        <p>å°è¯•è°ƒæ•´å…³é”®è¯ï¼Œæˆ–æµè§ˆ <a href="/archives" class="serenity-link">å½’æ¡£</a> ä¸ <a class="serenity-link" href="/categories">åˆ†ç±»</a>ã€‚</p>
    </div>
    {% else %}
    <div class="search-welcome">
        <p>âœ¨</p>
        <h3>å¼€å§‹ä½ çš„ç¬¬ä¸€æ¡æœç´¢</h3>
        <p>å¯ä»¥è¾“å…¥ä¸»é¢˜ã€æ ‡ç­¾æˆ–æ—¥æœŸ â€”â€” Serenity ä¼šå¸®ä½ å®šä½å†…å®¹ã€‚</p>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
{% if query %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const rawQuery = {{ query|tojson }};
    if (!rawQuery) {
        return;
    }
    const escaped = rawQuery.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    if (!escaped) {
        return;
    }
    const pattern = new RegExp(escaped, 'gi');

    const highlightNode = (root) => {
        const walker = document.createTreeWalker(
            root,
            NodeFilter.SHOW_TEXT,
            {
                acceptNode(node) {
                    if (!node.nodeValue.trim()) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    if (node.parentElement && node.parentElement.closest('.search-highlight')) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    return NodeFilter.FILTER_ACCEPT;
                }
            }
        );

        const pending = [];
        while (walker.nextNode()) {
            pending.push(walker.currentNode);
        }

        pending.forEach(textNode => {
            const value = textNode.nodeValue;
            pattern.lastIndex = 0;
            if (!pattern.test(value)) {
                return;
            }
            pattern.lastIndex = 0;
            const fragment = document.createDocumentFragment();
            let lastIndex = 0;
            let match;
            while ((match = pattern.exec(value)) !== null) {
                const start = match.index;
                if (start > lastIndex) {
                    fragment.appendChild(document.createTextNode(value.slice(lastIndex, start)));
                }
                const mark = document.createElement('mark');
                mark.className = 'search-highlight';
                mark.textContent = match[0];
                fragment.appendChild(mark);
                lastIndex = start + match[0].length;
            }
            if (lastIndex < value.length) {
                fragment.appendChild(document.createTextNode(value.slice(lastIndex)));
            }
            textNode.parentNode.replaceChild(fragment, textNode);
        });
    };

    document.querySelectorAll('.search-card h2, .search-card-excerpt').forEach(el => highlightNode(el));
});
</script>
{% endif %}
{% endblock %}
