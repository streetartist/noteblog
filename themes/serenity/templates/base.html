<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ page_title or (site_title or 'Noteblog') }}{% endblock %}</title>
    <meta name="description" content="{% block description %}{{ site_description or '' }}{% endblock %}">
    <meta name="keywords" content="{% block keywords %}{{ site_keywords or '' }}{% endblock %}">

    {% if get_theme_config().site_favicon %}
    <link rel="icon" href="{{ get_theme_config().site_favicon }}">
    {% endif %}

    <link rel="stylesheet" href="/themes/serenity/static/css/serenity.css">
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        :root {
            --serenity-primary: {{ get_theme_config().primary_color or '#4d6cfa' }};
            --serenity-accent: {{ get_theme_config().accent_color or '#f8b400' }};
            --serenity-neutral: {{ get_theme_config().neutral_color or '#1f2a37' }};
            --serenity-density: {{ get_theme_config().layout_density or 'cozy' }};
        }
    </style>
    {% if get_theme_config().enable_glass_header != false %}
    <style>
        body.serenity-body .serenity-header {
            backdrop-filter: blur(14px);
            background: rgba(250, 250, 252, 0.75);
        }
        [data-theme="dark"] .serenity-header {
            background: rgba(16, 18, 27, 0.75);
        }
    </style>
    {% endif %}

    {% block head %}{% endblock %}

    {% if plugin_hooks and plugin_hooks.head_assets %}
        {% for asset_content in plugin_hooks.head_assets %}
            {{ asset_content|safe }}
        {% endfor %}
    {% endif %}
</head>
<body class="serenity-body">
    <div class="serenity-app">
        <header class="serenity-header">
            <div class="serenity-container">
                <div class="serenity-logo">
                    {% if get_theme_config().site_logo %}
                    <a href="/" aria-label="{{ site_title or 'Noteblog' }}">
                        <img src="{{ get_theme_config().site_logo }}" alt="{{ site_title }}">
                    </a>
                    {% else %}
                    <a href="/">{{ site_title or 'Noteblog' }}</a>
                    {% endif %}
                </div>
                <button class="serenity-nav-toggle" type="button" aria-label="å±•å¼€å¯¼èˆª" data-nav-toggle>
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <nav class="serenity-nav" data-nav>
                    <a href="/" class="serenity-nav-link {% if request.path == '/' %}active{% endif %}">é¦–é¡µ</a>
                    <a href="/archives" class="serenity-nav-link {% if request.path.startswith('/archives') %}active{% endif %}">å½’æ¡£</a>
                    <a href="/categories" class="serenity-nav-link {% if request.path.startswith('/categories') %}active{% endif %}">åˆ†ç±»</a>
                    <a href="/tags" class="serenity-nav-link {% if request.path.startswith('/tags') %}active{% endif %}">æ ‡ç­¾</a>
                    <a href="/search" class="serenity-nav-link {% if request.path.startswith('/search') %}active{% endif %}">æœç´¢</a>
                    {% if plugin_hooks and plugin_hooks.nav %}
                        {% for hook_content in plugin_hooks.nav %}
                            {{ hook_content|safe }}
                        {% endfor %}
                    {% endif %}
                </nav>
                <div class="serenity-actions">
                    <button class="serenity-icon-button" type="button" data-search-toggle title="æœç´¢">
                        <span class="sr-only">æœç´¢æ–‡ç« </span>
                        ğŸ”
                    </button>
                    {% if get_theme_config().enable_dark_mode != false %}
                    <button class="serenity-icon-button theme-toggle" type="button" title="åˆ‡æ¢æ·±æµ…è‰²">
                        <span class="sr-only">åˆ‡æ¢ä¸»é¢˜</span>
                        â˜€ï¸
                    </button>
                    {% endif %}
                    {% if current_user.is_authenticated %}
                    <details class="serenity-user-menu">
                        <summary>
                            <div class="user-avatar">{{ (current_user.display_name or current_user.username)[:1].upper() }}</div>
                            <span class="user-name">{{ current_user.display_name or current_user.username }}</span>
                        </summary>
                        <div class="user-menu-panel">
                            <a href="/auth/profile">ä¸ªäººèµ„æ–™</a>
                            <a href="/?modal=edit_profile" data-modal-trigger="edit_profile">ç¼–è¾‘èµ„æ–™</a>
                            {% if current_user.is_admin %}
                            <a href="/admin">ç®¡ç†åå°</a>
                            {% endif %}
                            <a href="/auth/logout">é€€å‡ºç™»å½•</a>
                        </div>
                    </details>
                    {% else %}
                    <button class="serenity-ghost-button" type="button" data-modal-trigger="login">ç™»å½•</button>
                    <button class="serenity-solid-button" type="button" data-modal-trigger="register">æ³¨å†Œ</button>
                    {% endif %}
                </div>
            </div>
        </header>

        {% block hero %}{% endblock %}

        <main class="serenity-main">
            <div class="serenity-container">
                <div class="serenity-layout {% if get_theme_config().show_sidebar == false or _admin_page %}no-sidebar{% endif %}">
                    <div class="main-content">
                        {% if plugin_hooks and plugin_hooks.content_top %}
                            {% for hook_content in plugin_hooks.content_top %}
                                {{ hook_content|safe }}
                            {% endfor %}
                        {% endif %}
                        {% block content %}{% endblock %}
                        {% if plugin_hooks and plugin_hooks.content_bottom %}
                            {% for hook_content in plugin_hooks.content_bottom %}
                                {{ hook_content|safe }}
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% if get_theme_config().show_sidebar != false and not _admin_page %}
                    <aside class="sidebar">
                        {% block sidebar %}
                        <section class="widget">
                            <h3 class="widget-title">æœ€æ–°æ–‡ç« </h3>
                            <ul class="widget-list">
                                {% for post in (recent_posts|default([]))[:5] %}
                                <li><a href="/post/{{ post.slug }}">{{ post.title }}</a></li>
                                {% endfor %}
                            </ul>
                        </section>
                        <section class="widget">
                            <h3 class="widget-title">åˆ†ç±»</h3>
                            <ul class="widget-list">
                                {% for category in (categories|default([])) %}
                                <li><a href="/category/{{ category.slug }}">{{ category.name }} ({{ category.post_count or 0 }})</a></li>
                                {% endfor %}
                            </ul>
                        </section>
                        <section class="widget">
                            <h3 class="widget-title">æ ‡ç­¾</h3>
                            <div class="tag-cloud">
                                {% for tag in (tags|default([])) %}
                                <a class="tag-pill" href="/tag/{{ tag.slug }}">{{ tag.name }}</a>
                                {% endfor %}
                            </div>
                        </section>
                        {% if plugin_hooks and plugin_hooks.sidebar_bottom %}
                            {% for hook_content in plugin_hooks.sidebar_bottom %}
                                {{ hook_content|safe }}
                            {% endfor %}
                        {% endif %}
                        {% endblock %}
                    </aside>
                    {% endif %}
                </div>
            </div>
        </main>

        <footer class="serenity-footer">
            <div class="serenity-container">
                <p>{{ get_theme_config().footer_text or 'Â© 2025 Serenity Theme for Noteblog.' }}</p>
                <p>
                    Powered by <a href="https://github.com/streetartist/noteblog">Noteblog</a> Â· Theme Serenity
                </p>
                {% if plugin_hooks and plugin_hooks.footer %}
                    {% for hook_content in plugin_hooks.footer %}
                        {{ hook_content|safe }}
                    {% endfor %}
                {% endif %}
            </div>
        </footer>

        <button class="serenity-back-to-top" type="button" title="å›åˆ°é¡¶éƒ¨" aria-label="å›åˆ°é¡¶éƒ¨">
            â†‘
        </button>

        <div class="serenity-search-modal" aria-hidden="true">
            <div class="search-panel" role="dialog" aria-modal="true">
                <header>
                    <h3>æœç´¢æ–‡ç« </h3>
                    <button class="serenity-icon-button" type="button" data-search-close aria-label="å…³é—­æœç´¢">Ã—</button>
                </header>
                <form action="/search" method="GET">
                    <input type="text" name="q" placeholder="è¾“å…¥å…³é”®è¯..." autocomplete="off">
                    <button type="submit">æœç´¢</button>
                </form>
                <p class="search-hint">æŒ‰ ESC å…³é—­</p>
            </div>
        </div>

        {% if not current_user.is_authenticated %}
        {% include 'auth/login.html' %}
        {% endif %}

        {% if current_user.is_authenticated %}
        <div class="serenity-modal" data-modal="edit_profile" aria-hidden="true">
            <div class="modal-card" role="dialog" aria-modal="true">
                <header>
                    <h3>ç¼–è¾‘èµ„æ–™</h3>
                    <button type="button" class="serenity-icon-button" data-modal-close aria-label="å…³é—­">Ã—</button>
                </header>
                <form action="{{ url_for('auth.edit_profile') }}" method="POST" enctype="multipart/form-data">
                    <label>æ˜¾ç¤ºåç§°
                        <input type="text" name="display_name" value="{{ current_user.display_name or current_user.username }}">
                    </label>
                    <label>é‚®ç®±
                        <input type="email" name="email" value="{{ current_user.email or '' }}">
                    </label>
                    <label>ä¸ªäººç½‘ç«™
                        <input type="url" name="website" value="{{ current_user.website or '' }}" placeholder="https://example.com">
                    </label>
                    <label>æ‰€åœ¨åœ°
                        <input type="text" name="location" value="{{ current_user.location or '' }}">
                    </label>
                    <label>ç®€ä»‹
                        <textarea name="bio" rows="3">{{ current_user.bio or '' }}</textarea>
                    </label>
                    <label>å¤´åƒ
                        <input type="file" name="avatar" accept="image/png,image/jpeg,image/webp">
                    </label>
                    <button type="submit" class="serenity-solid-button">ä¿å­˜</button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="/themes/serenity/static/js/serenity.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script>
    (function() {
        const options = {
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\[', right: '\\]', display: true },
                { left: '\\(', right: '\\)', display: false }
            ],
            throwOnError: false
        };
        document.addEventListener('DOMContentLoaded', function() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, options);
            }
        });
        window.addEventListener('serenity:content-updated', function(event) {
            if (window.renderMathInElement) {
                renderMathInElement(event.detail?.root || document.body, options);
            }
        });
    })();
    </script>

    {% block scripts %}{% endblock %}

    {% if plugin_hooks and plugin_hooks.scripts_assets %}
        {% for asset_content in plugin_hooks.scripts_assets %}
            {{ asset_content|safe }}
        {% endfor %}
    {% endif %}

    {% if get_theme_config().analytics_code %}
        {{ get_theme_config().analytics_code|safe }}
    {% endif %}
</body>
</html>
