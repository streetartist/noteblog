<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ page_title or (site_title or 'Noteblog') }}{% endblock %}</title>
    <meta name="description" content="{% block description %}{{ site_description or '' }}{% endblock %}">
    <meta name="keywords" content="{% block keywords %}{{ site_keywords or '' }}{% endblock %}">

    {% if get_theme_config().site_favicon %}
    <link rel="icon" href="{{ get_theme_config().site_favicon }}">
    {% endif %}

    <link rel="stylesheet" href="/themes/serenity/static/css/serenity.css">
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        :root {
            --serenity-primary: {{ get_theme_config().primary_color or '#4d6cfa' }};
            --serenity-accent: {{ get_theme_config().accent_color or '#f8b400' }};
            --serenity-neutral: {{ get_theme_config().neutral_color or '#1f2a37' }};
            --serenity-density: {{ get_theme_config().layout_density or 'cozy' }};
        }
    </style>
    {% if get_theme_config().enable_glass_header != false %}
    <style>
        body.serenity-body .serenity-header {
            backdrop-filter: blur(14px);
            background: rgba(250, 250, 252, 0.75);
        }
        [data-theme="dark"] .serenity-header {
            background: rgba(16, 18, 27, 0.75);
        }
    </style>
    {% endif %}

    {% block head %}{% endblock %}

    {% if plugin_hooks and plugin_hooks.head_assets %}
        {% for asset_content in plugin_hooks.head_assets %}
            {{ asset_content|safe }}
        {% endfor %}
    {% endif %}
</head>
<body class="serenity-body">
    <div class="serenity-app">
        <header class="serenity-header">
            <div class="serenity-container">
                <div class="serenity-logo">
                    {% if get_theme_config().site_logo %}
                    <a href="/" aria-label="{{ site_title or 'Noteblog' }}">
                        <img src="{{ get_theme_config().site_logo }}" alt="{{ site_title }}">
                    </a>
                    {% else %}
                    <a href="/">{{ site_title or 'Noteblog' }}</a>
                    {% endif %}
                </div>
                <button class="serenity-nav-toggle" type="button" aria-label="å±•å¼€å¯¼èˆª" data-nav-toggle>
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <nav class="serenity-nav" data-nav>
                    <a href="/" class="serenity-nav-link {% if request.path == '/' %}active{% endif %}">é¦–é¡µ</a>
                    <a href="/archives" class="serenity-nav-link {% if request.path.startswith('/archives') %}active{% endif %}">å½’æ¡£</a>
                    <a href="/categories" class="serenity-nav-link {% if request.path.startswith('/categories') %}active{% endif %}">åˆ†ç±»</a>
                    <a href="/tags" class="serenity-nav-link {% if request.path.startswith('/tags') %}active{% endif %}">æ ‡ç­¾</a>
                    <a href="/search" class="serenity-nav-link {% if request.path.startswith('/search') %}active{% endif %}">æœç´¢</a>
                    {% if plugin_hooks and plugin_hooks.nav %}
                        {% for hook_content in plugin_hooks.nav %}
                            {{ hook_content|safe }}
                        {% endfor %}
                    {% endif %}
                </nav>
                <div class="serenity-actions">
                    <button class="serenity-icon-button" type="button" data-search-toggle title="æœç´¢">
                        <span class="sr-only">æœç´¢æ–‡ç« </span>
                        ğŸ”
                    </button>
                    {% if get_theme_config().enable_dark_mode != false %}
                    <button class="serenity-icon-button theme-toggle" type="button" title="åˆ‡æ¢æ·±æµ…è‰²">
                        <span class="sr-only">åˆ‡æ¢ä¸»é¢˜</span>
                        â˜€ï¸
                    </button>
                    {% endif %}
                    {% if current_user.is_authenticated %}
                    <details class="serenity-user-menu">
                        <summary>
                            <div class="user-avatar">{{ (current_user.display_name or current_user.username)[:1].upper() }}</div>
                            <span class="user-name">{{ current_user.display_name or current_user.username }}</span>
                        </summary>
                        <div class="user-menu-panel">
                            <a href="/auth/profile">ä¸ªäººèµ„æ–™</a>
                            <a href="/?modal=edit_profile" data-modal-trigger="edit_profile">ç¼–è¾‘èµ„æ–™</a>
                            <a href="javascript:void(0)" data-modal-trigger="change_password">ä¿®æ”¹å¯†ç </a>
                            {% if current_user.is_admin %}
                            <a href="/admin">ç®¡ç†åå°</a>
                            {% endif %}
                            <a href="/auth/logout">é€€å‡ºç™»å½•</a>
                        </div>
                    </details>
                    {% else %}
                    <button class="serenity-ghost-button" type="button" data-modal-trigger="login">ç™»å½•</button>
                    <button class="serenity-solid-button" type="button" data-modal-trigger="register">æ³¨å†Œ</button>
                    {% endif %}
                </div>
            </div>
        </header>

        {% block hero %}{% endblock %}

        <main class="serenity-main">
            <div class="serenity-container">
                <div class="serenity-layout {% if get_theme_config().show_sidebar == false or _admin_page %}no-sidebar{% endif %}">
                    <div class="main-content">
                        {% if plugin_hooks and plugin_hooks.content_top %}
                            {% for hook_content in plugin_hooks.content_top %}
                                {{ hook_content|safe }}
                            {% endfor %}
                        {% endif %}
                        {% block content %}{% endblock %}
                        {% if plugin_hooks and plugin_hooks.content_bottom %}
                            {% for hook_content in plugin_hooks.content_bottom %}
                                {{ hook_content|safe }}
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% if get_theme_config().show_sidebar != false and not _admin_page %}
                    <aside class="sidebar">
                        {% block sidebar %}
                        <section class="widget">
                            <h3 class="widget-title">æœ€æ–°æ–‡ç« </h3>
                            <ul class="widget-list">
                                {% for post in (recent_posts|default([]))[:5] %}
                                <li><a href="/post/{{ post.slug }}">{{ post.title }}</a></li>
                                {% endfor %}
                            </ul>
                        </section>
                        <section class="widget">
                            <h3 class="widget-title">åˆ†ç±»</h3>
                            <ul class="widget-list">
                                {% for category in (categories|default([])) %}
                                <li><a href="/category/{{ category.slug }}">{{ category.name }} ({{ category.post_count or 0 }})</a></li>
                                {% endfor %}
                            </ul>
                        </section>
                        <section class="widget">
                            <h3 class="widget-title">æ ‡ç­¾</h3>
                            <div class="tag-cloud">
                                {% for tag in (tags|default([])) %}
                                <a class="tag-pill" href="/tag/{{ tag.slug }}">{{ tag.name }}</a>
                                {% endfor %}
                            </div>
                        </section>
                        {% if plugin_hooks and plugin_hooks.sidebar_bottom %}
                            {% for hook_content in plugin_hooks.sidebar_bottom %}
                                {{ hook_content|safe }}
                            {% endfor %}
                        {% endif %}
                        {% endblock %}
                    </aside>
                    {% endif %}
                </div>
            </div>
        </main>

        <footer class="serenity-footer">
            <div class="serenity-container">
                {{ get_setting('footer_text', '<p>Â© 2025 Serenity Theme for Noteblog.</p><p>Powered by <a href=\"https://github.com/streetartist/noteblog\">Noteblog</a> Â· Theme Serenity</p>')|safe }}
                {% if plugin_hooks and plugin_hooks.footer %}
                    {% for hook_content in plugin_hooks.footer %}
                        {{ hook_content|safe }}
                    {% endfor %}
                {% endif %}
            </div>
        </footer>

        <button class="serenity-back-to-top" type="button" title="å›åˆ°é¡¶éƒ¨" aria-label="å›åˆ°é¡¶éƒ¨">
            â†‘
        </button>

        <div class="serenity-search-modal" aria-hidden="true">
            <div class="search-panel" role="dialog" aria-modal="true">
                <header>
                    <h3>æœç´¢æ–‡ç« </h3>
                    <button class="serenity-icon-button" type="button" data-search-close aria-label="å…³é—­æœç´¢">Ã—</button>
                </header>
                <form action="/search" method="GET">
                    <input type="text" name="q" placeholder="è¾“å…¥å…³é”®è¯..." autocomplete="off">
                    <button type="submit">æœç´¢</button>
                </form>
                <p class="search-hint">æŒ‰ ESC å…³é—­</p>
            </div>
        </div>

        {% if not current_user.is_authenticated %}
        {% include 'auth/login.html' %}
        {% endif %}

        {% if current_user.is_authenticated %}
        <div class="serenity-modal" data-modal="edit_profile" aria-hidden="true">
            <div class="modal-card" role="dialog" aria-modal="true">
                <header>
                    <h3>ç¼–è¾‘èµ„æ–™</h3>
                    <button type="button" class="serenity-icon-button" data-modal-close aria-label="å…³é—­">Ã—</button>
                </header>
                <form action="{{ url_for('auth.edit_profile') }}" method="POST" enctype="multipart/form-data">
                    <label>æ˜¾ç¤ºåç§°
                        <input type="text" name="display_name" value="{{ current_user.display_name or current_user.username }}">
                    </label>
                    <label>é‚®ç®±
                        <input type="email" name="email" value="{{ current_user.email or '' }}">
                    </label>
                    <label>ä¸ªäººç½‘ç«™
                        <input type="url" name="website" value="{{ current_user.website or '' }}" placeholder="https://example.com">
                    </label>
                    <label>æ‰€åœ¨åœ°
                        <input type="text" name="location" value="{{ current_user.location or '' }}">
                    </label>
                    <label>ç®€ä»‹
                        <textarea name="bio" rows="3">{{ current_user.bio or '' }}</textarea>
                    </label>
                    <label>å¤´åƒ
                        <input type="file" name="avatar" accept="image/png,image/jpeg,image/webp">
                    </label>
                    <button type="submit" class="serenity-solid-button">ä¿å­˜</button>
                </form>
            </div>
        </div>

        <div class="serenity-modal" data-modal="change_password" aria-hidden="true">
            <div class="modal-card" role="dialog" aria-modal="true">
                <header>
                    <h3>ä¿®æ”¹å¯†ç </h3>
                    <button type="button" class="serenity-icon-button" data-modal-close aria-label="å…³é—­">Ã—</button>
                </header>
                <form action="{{ url_for('auth.change_password') }}" method="POST" id="change-password-form">
                    <label for="current-password">å½“å‰å¯†ç 
                        <input id="current-password" type="password" name="current_password" autocomplete="current-password" required>
                    </label>
                    <label for="new-password">æ–°å¯†ç 
                        <input id="new-password" type="password" name="new_password" minlength="6" autocomplete="new-password" required>
                        <small class="field-hint">å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½</small>
                    </label>
                    <label for="confirm-password">ç¡®è®¤æ–°å¯†ç 
                        <input id="confirm-password" type="password" name="confirm_password" minlength="6" autocomplete="new-password" required>
                    </label>
                    <div class="password-strength-container" id="password-strength-container" style="display: none;">
                        <div class="password-strength-label">å¯†ç å¼ºåº¦ï¼š<span id="strength-text">å¼±</span></div>
                        <div class="password-strength-bar">
                            <div class="password-strength-fill" id="strength-fill"></div>
                        </div>
                    </div>
                    <div class="password-match-hint" id="password-match-hint" style="display: none;"></div>
                    <div class="modal-actions">
                        <button type="button" class="serenity-ghost-button" data-modal-close>å–æ¶ˆ</button>
                        <button type="submit" class="serenity-solid-button">ä¿®æ”¹å¯†ç </button>
                    </div>
                </form>
            </div>
        </div>

        <style>
        .field-hint {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--serenity-text-muted, #6b7280);
        }
        .password-strength-container {
            margin: 12px 0;
            padding: 12px;
            background: var(--serenity-bg-soft, #f9fafb);
            border-radius: 6px;
        }
        .password-strength-label {
            font-size: 13px;
            margin-bottom: 8px;
            color: var(--serenity-text-secondary, #4b5563);
        }
        .password-strength-bar {
            width: 100%;
            height: 4px;
            background: var(--serenity-border, #e5e7eb);
            border-radius: 2px;
            overflow: hidden;
        }
        .password-strength-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease, background-color 0.3s ease;
            border-radius: 2px;
        }
        .password-strength-fill.weak {
            width: 33%;
            background-color: #ef4444;
        }
        .password-strength-fill.medium {
            width: 66%;
            background-color: #f59e0b;
        }
        .password-strength-fill.strong {
            width: 100%;
            background-color: #10b981;
        }
        .password-match-hint {
            font-size: 13px;
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 4px;
        }
        .password-match-hint.match {
            background: #d1fae5;
            color: #065f46;
        }
        .password-match-hint.mismatch {
            background: #fee2e2;
            color: #991b1b;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        [data-theme="dark"] .password-strength-container {
            background: var(--serenity-bg-soft, #1f2937);
        }
        [data-theme="dark"] .password-match-hint.match {
            background: #064e3b;
            color: #a7f3d0;
        }
        [data-theme="dark"] .password-match-hint.mismatch {
            background: #7f1d1d;
            color: #fecaca;
        }
        </style>

        <script>
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('change-password-form');
                if (!form) return;

                const newPasswordInput = form.querySelector('#new-password');
                const confirmPasswordInput = form.querySelector('#confirm-password');
                const strengthContainer = document.getElementById('password-strength-container');
                const strengthFill = document.getElementById('strength-fill');
                const strengthText = document.getElementById('strength-text');
                const matchHint = document.getElementById('password-match-hint');

                function checkStrength(password) {
                    let score = 0;
                    if (password.length >= 6) score++;
                    if (password.length >= 8) score++;
                    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
                    if (/\d/.test(password)) score++;
                    if (/[^a-zA-Z0-9]/.test(password)) score++;
                    return score;
                }

                function updateStrength() {
                    const password = newPasswordInput.value;
                    if (password.length === 0) {
                        strengthContainer.style.display = 'none';
                        return;
                    }
                    strengthContainer.style.display = 'block';
                    const score = checkStrength(password);
                    strengthFill.className = 'password-strength-fill';
                    if (score <= 2) {
                        strengthFill.classList.add('weak');
                        strengthText.textContent = 'å¼±';
                    } else if (score <= 3) {
                        strengthFill.classList.add('medium');
                        strengthText.textContent = 'ä¸­ç­‰';
                    } else {
                        strengthFill.classList.add('strong');
                        strengthText.textContent = 'å¼º';
                    }
                }

                function updateMatch() {
                    const newPass = newPasswordInput.value;
                    const confirmPass = confirmPasswordInput.value;
                    if (confirmPass.length === 0) {
                        matchHint.style.display = 'none';
                        return;
                    }
                    matchHint.style.display = 'block';
                    if (newPass === confirmPass) {
                        matchHint.className = 'password-match-hint match';
                        matchHint.textContent = 'âœ“ å¯†ç åŒ¹é…';
                    } else {
                        matchHint.className = 'password-match-hint mismatch';
                        matchHint.textContent = 'âœ— å¯†ç ä¸åŒ¹é…';
                    }
                }

                newPasswordInput.addEventListener('input', function() {
                    updateStrength();
                    if (confirmPasswordInput.value) updateMatch();
                });
                confirmPasswordInput.addEventListener('input', updateMatch);

                form.addEventListener('submit', function(e) {
                    const currentPass = form.querySelector('#current-password').value;
                    const newPass = newPasswordInput.value;
                    const confirmPass = confirmPasswordInput.value;

                    if (!currentPass) {
                        e.preventDefault();
                        alert('è¯·è¾“å…¥å½“å‰å¯†ç ');
                        return false;
                    }
                    if (newPass.length < 6) {
                        e.preventDefault();
                        alert('æ–°å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½');
                        return false;
                    }
                    if (newPass !== confirmPass) {
                        e.preventDefault();
                        alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                        return false;
                    }
                    if (currentPass === newPass) {
                        e.preventDefault();
                        alert('æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ');
                        return false;
                    }
                });
            });
        })();
        </script>
        {% endif %}
    </div>

    <script src="/themes/serenity/static/js/serenity.js"></script>
    <script>
    (function() {
        function formatDate(date, format) {
            var pad = function(n) { return n < 10 ? '0' + n : n; };
            var map = {
                '%Y': date.getFullYear(),
                '%m': pad(date.getMonth() + 1),
                '%d': pad(date.getDate()),
                '%H': pad(date.getHours()),
                '%M': pad(date.getMinutes()),
                '%S': pad(date.getSeconds())
            };
            var result = format;
            for (var key in map) {
                result = result.replace(key, map[key]);
            }
            return result;
        }
        function convertToLocalTime() {
            document.querySelectorAll('time[data-localtime]').forEach(function(el) {
                var utcTime = el.getAttribute('datetime');
                if (!utcTime) return;
                try {
                    var date = new Date(utcTime);
                    if (isNaN(date.getTime())) return;
                    var format = el.getAttribute('data-format') || '%Y-%m-%d %H:%M:%S';
                    el.textContent = formatDate(date, format);
                    el.removeAttribute('data-localtime');
                } catch (e) {}
            });
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', convertToLocalTime);
        } else {
            convertToLocalTime();
        }
        window.addEventListener('serenity:content-updated', convertToLocalTime);
    })();
    </script>
    <script src="https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script>
    (function() {
        const options = {
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\[', right: '\\]', display: true },
                { left: '\\(', right: '\\)', display: false }
            ],
            throwOnError: false
        };
        document.addEventListener('DOMContentLoaded', function() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, options);
            }
        });
        window.addEventListener('serenity:content-updated', function(event) {
            if (window.renderMathInElement) {
                renderMathInElement(event.detail?.root || document.body, options);
            }
        });
    })();
    </script>

    {% block scripts %}{% endblock %}

    {% if plugin_hooks and plugin_hooks.scripts_assets %}
        {% for asset_content in plugin_hooks.scripts_assets %}
            {{ asset_content|safe }}
        {% endfor %}
    {% endif %}

    {% if get_theme_config().analytics_code %}
        {{ get_theme_config().analytics_code|safe }}
    {% endif %}
</body>
</html>
