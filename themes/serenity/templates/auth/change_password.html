{% extends "base.html" %}

{% block title %}{{ page_title or ('修改密码 - ' ~ (site_title or 'Noteblog')) }}{% endblock %}

{% block content %}
<div class="serenity-page-header">
    <h1>修改密码</h1>
    <p>为了账户安全，请定期更新您的密码</p>
</div>

<div class="serenity-card change-password-card">
    <form action="{{ url_for('auth.change_password') }}" method="POST" id="change-password-form" class="change-password-form">
        <div class="form-group">
            <label for="current-password">当前密码</label>
            <input id="current-password" type="password" name="current_password" autocomplete="current-password" required>
        </div>
        
        <div class="form-group">
            <label for="new-password">新密码</label>
            <input id="new-password" type="password" name="new_password" minlength="6" autocomplete="new-password" required>
            <small class="field-hint">密码长度至少为6位</small>
        </div>
        
        <div class="form-group">
            <label for="confirm-password">确认新密码</label>
            <input id="confirm-password" type="password" name="confirm_password" minlength="6" autocomplete="new-password" required>
        </div>
        
        <div class="password-strength-container" id="password-strength-container" style="display: none;">
            <div class="password-strength-label">密码强度：<span id="strength-text">弱</span></div>
            <div class="password-strength-bar">
                <div class="password-strength-fill" id="strength-fill"></div>
            </div>
        </div>
        
        <div class="password-match-hint" id="password-match-hint" style="display: none;"></div>
        
        <div class="password-requirements">
            <h4>密码要求：</h4>
            <ul>
                <li id="length-check" class="check-item">
                    <span class="check-icon">○</span>
                    <span>至少6个字符</span>
                </li>
                <li id="complexity-check" class="check-item">
                    <span class="check-icon">○</span>
                    <span>包含字母和数字（推荐）</span>
                </li>
            </ul>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('auth.profile') }}" class="serenity-ghost-button">取消</a>
            <button type="submit" class="serenity-solid-button">修改密码</button>
        </div>
    </form>
</div>

<style>
.serenity-page-header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 2rem 0;
}

.serenity-page-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: var(--serenity-neutral, #1f2a37);
    margin-bottom: 0.5rem;
}

.serenity-page-header p {
    color: var(--serenity-text-muted, #6b7280);
    font-size: 1rem;
}

.change-password-card {
    max-width: 480px;
    margin: 0 auto 3rem;
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] .change-password-card {
    background: var(--serenity-card-bg, #1f2937);
}

.change-password-form .form-group {
    margin-bottom: 1.5rem;
}

.change-password-form label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--serenity-neutral, #1f2a37);
}

[data-theme="dark"] .change-password-form label {
    color: var(--serenity-text, #f3f4f6);
}

.change-password-form input[type="password"] {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--serenity-border, #e5e7eb);
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    background: white;
}

[data-theme="dark"] .change-password-form input[type="password"] {
    background: var(--serenity-bg-soft, #374151);
    border-color: var(--serenity-border-dark, #4b5563);
    color: var(--serenity-text, #f3f4f6);
}

.change-password-form input[type="password"]:focus {
    outline: none;
    border-color: var(--serenity-primary, #4d6cfa);
    box-shadow: 0 0 0 3px rgba(77, 108, 250, 0.15);
}

.field-hint {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.8125rem;
    color: var(--serenity-text-muted, #6b7280);
}

.password-strength-container {
    margin: 1rem 0;
    padding: 1rem;
    background: var(--serenity-bg-soft, #f9fafb);
    border-radius: 8px;
}

[data-theme="dark"] .password-strength-container {
    background: var(--serenity-bg-soft, #374151);
}

.password-strength-label {
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    color: var(--serenity-text-secondary, #4b5563);
}

[data-theme="dark"] .password-strength-label {
    color: var(--serenity-text-muted, #9ca3af);
}

.password-strength-bar {
    width: 100%;
    height: 6px;
    background: var(--serenity-border, #e5e7eb);
    border-radius: 3px;
    overflow: hidden;
}

.password-strength-fill {
    height: 100%;
    width: 0%;
    transition: width 0.3s ease, background-color 0.3s ease;
    border-radius: 3px;
}

.password-strength-fill.weak {
    width: 33%;
    background-color: #ef4444;
}

.password-strength-fill.medium {
    width: 66%;
    background-color: #f59e0b;
}

.password-strength-fill.strong {
    width: 100%;
    background-color: #10b981;
}

.password-match-hint {
    font-size: 0.875rem;
    margin: 1rem 0;
    padding: 0.75rem 1rem;
    border-radius: 8px;
}

.password-match-hint.match {
    background: #d1fae5;
    color: #065f46;
}

.password-match-hint.mismatch {
    background: #fee2e2;
    color: #991b1b;
}

[data-theme="dark"] .password-match-hint.match {
    background: #064e3b;
    color: #a7f3d0;
}

[data-theme="dark"] .password-match-hint.mismatch {
    background: #7f1d1d;
    color: #fecaca;
}

.password-requirements {
    background: var(--serenity-bg-soft, #f0f9ff);
    border: 1px solid var(--serenity-primary-light, #bfdbfe);
    border-radius: 8px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
}

[data-theme="dark"] .password-requirements {
    background: rgba(77, 108, 250, 0.1);
    border-color: rgba(77, 108, 250, 0.3);
}

.password-requirements h4 {
    margin: 0 0 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--serenity-primary, #4d6cfa);
}

.password-requirements ul {
    margin: 0;
    padding: 0;
    list-style: none;
}

.check-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: var(--serenity-text-muted, #6b7280);
}

.check-item:last-child {
    margin-bottom: 0;
}

.check-item.valid {
    color: #10b981;
}

.check-item .check-icon {
    font-size: 1rem;
}

.check-item.valid .check-icon::before {
    content: '✓';
}

.check-item:not(.valid) .check-icon::before {
    content: '○';
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
}

@media (max-width: 480px) {
    .change-password-card {
        margin: 0 1rem 2rem;
        padding: 1.5rem;
    }
    
    .form-actions {
        flex-direction: column-reverse;
    }
    
    .form-actions .serenity-ghost-button,
    .form-actions .serenity-solid-button {
        width: 100%;
        justify-content: center;
    }
}
</style>

<script>
(function() {
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('change-password-form');
        if (!form) return;

        const newPasswordInput = form.querySelector('#new-password');
        const confirmPasswordInput = form.querySelector('#confirm-password');
        const strengthContainer = document.getElementById('password-strength-container');
        const strengthFill = document.getElementById('strength-fill');
        const strengthText = document.getElementById('strength-text');
        const matchHint = document.getElementById('password-match-hint');
        const lengthCheck = document.getElementById('length-check');
        const complexityCheck = document.getElementById('complexity-check');

        function checkStrength(password) {
            let score = 0;
            const checks = {
                length: password.length >= 6,
                complexity: /[a-zA-Z]/.test(password) && /\d/.test(password)
            };
            
            if (checks.length) score++;
            if (password.length >= 8) score++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
            if (/\d/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;
            
            return { score, checks };
        }

        function updateStrength() {
            const password = newPasswordInput.value;
            if (password.length === 0) {
                strengthContainer.style.display = 'none';
                lengthCheck.classList.remove('valid');
                complexityCheck.classList.remove('valid');
                return;
            }
            
            strengthContainer.style.display = 'block';
            const result = checkStrength(password);
            
            // Update strength bar
            strengthFill.className = 'password-strength-fill';
            if (result.score <= 2) {
                strengthFill.classList.add('weak');
                strengthText.textContent = '弱';
            } else if (result.score <= 3) {
                strengthFill.classList.add('medium');
                strengthText.textContent = '中等';
            } else {
                strengthFill.classList.add('strong');
                strengthText.textContent = '强';
            }
            
            // Update check items
            if (result.checks.length) {
                lengthCheck.classList.add('valid');
            } else {
                lengthCheck.classList.remove('valid');
            }
            
            if (result.checks.complexity) {
                complexityCheck.classList.add('valid');
            } else {
                complexityCheck.classList.remove('valid');
            }
        }

        function updateMatch() {
            const newPass = newPasswordInput.value;
            const confirmPass = confirmPasswordInput.value;
            
            if (confirmPass.length === 0) {
                matchHint.style.display = 'none';
                return;
            }
            
            matchHint.style.display = 'block';
            if (newPass === confirmPass) {
                matchHint.className = 'password-match-hint match';
                matchHint.textContent = '✓ 密码匹配';
            } else {
                matchHint.className = 'password-match-hint mismatch';
                matchHint.textContent = '✗ 密码不匹配';
            }
        }

        newPasswordInput.addEventListener('input', function() {
            updateStrength();
            if (confirmPasswordInput.value) updateMatch();
        });
        
        confirmPasswordInput.addEventListener('input', updateMatch);

        form.addEventListener('submit', function(e) {
            const currentPass = form.querySelector('#current-password').value;
            const newPass = newPasswordInput.value;
            const confirmPass = confirmPasswordInput.value;

            if (!currentPass) {
                e.preventDefault();
                alert('请输入当前密码');
                return false;
            }
            
            if (newPass.length < 6) {
                e.preventDefault();
                alert('新密码长度至少为6位');
                return false;
            }
            
            if (newPass !== confirmPass) {
                e.preventDefault();
                alert('两次输入的新密码不一致');
                return false;
            }
            
            if (currentPass === newPass) {
                e.preventDefault();
                alert('新密码不能与当前密码相同');
                return false;
            }
        });
    });
})();
</script>
{% endblock %}
