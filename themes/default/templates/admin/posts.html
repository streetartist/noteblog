{% extends "admin/base.html" %}

{% block admin_content %}
<div id="posts-app">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #303133;">æ–‡ç« ç®¡ç†</h2>
        <a href="/admin/posts/create" style="padding: 8px 16px; background: #409eff; color: white; text-decoration: none; border-radius: 4px;">
            + æ–°å»ºæ–‡ç« 
        </a>
    </div>

    <!-- ç­›é€‰å™¨ -->
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="color: #606266; font-size: 14px;">çŠ¶æ€ç­›é€‰ï¼š</label>
                <select id="statusFilter" style="padding: 8px; border: 1px solid #dcdfe6; border-radius: 4px;">
                    <option value="">å…¨éƒ¨</option>
                    <option value="published" {% if status == 'published' %}selected{% endif %}>å·²å‘å¸ƒ</option>
                    <option value="draft" {% if status == 'draft' %}selected{% endif %}>è‰ç¨¿</option>
                </select>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="color: #606266; font-size: 14px;">åˆ†ç±»ç­›é€‰ï¼š</label>
                <select id="categoryFilter" style="padding: 8px; border: 1px solid #dcdfe6; border-radius: 4px;">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if category_id == category.id|string %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- æ–‡ç« åˆ—è¡¨ -->
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead style="background: #f5f7fa;">
                <tr>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5;">æ ‡é¢˜</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5;">åˆ†ç±»</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5;">ä½œè€…</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5;">çŠ¶æ€</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5;">å‘å¸ƒæ—¶é—´</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5; width: 200px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for post in posts.items %}
                <tr style="border-bottom: 1px solid #ebeef5;">
                    <td style="padding: 12px;">
                        <div style="line-height: 1.5;">
                            <div style="font-weight: 500; color: #303133; margin-bottom: 4px;">
                                {{ post.title }}
                            </div>
                            <div style="color: #606266; font-size: 14px;">
                                {{ post.excerpt[:100] if post.excerpt else post.content[:100] }}{% if (post.excerpt or post.content)|length > 100 %}...{% endif %}
                            </div>
                        </div>
                    </td>
                    <td style="padding: 12px; color: #606266;">
                        {{ post.category.name if post.category else 'æœªåˆ†ç±»' }}
                    </td>
                    <td style="padding: 12px; color: #606266;">
                        {{ post.author.username if post.author else 'æœªçŸ¥' }}
                    </td>
                    <td style="padding: 12px;">
                        {% if post.status == 'published' %}
                        <span style="padding: 4px 8px; background: #f0f9ff; color: #67c23a; border-radius: 4px; font-size: 12px;">å·²å‘å¸ƒ</span>
                        {% else %}
                        <span style="padding: 4px 8px; background: #fdf6ec; color: #e6a23c; border-radius: 4px; font-size: 12px;">è‰ç¨¿</span>
                        {% endif %}
                    </td>
                    <td style="padding: 12px; color: #606266; font-size: 13px;">
                        {{ post.published_at.strftime('%Y-%m-%d %H:%M') if post.published_at else '' }}
                    </td>
                    <td style="padding: 12px;">
                        <a href="/admin/posts/{{ post.id }}/edit" style="padding: 5px 10px; background: #409eff; color: white; text-decoration: none; border-radius: 4px; margin-right: 5px; display: inline-block;">
                            ç¼–è¾‘
                        </a>
                        <button onclick="deletePost({{ post.id }}, '{{ post.title }}')" style="padding: 5px 10px; background: #f56c6c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            åˆ é™¤
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if not posts.items %}
        <div style="text-align: center; padding: 60px;">
            <div style="font-size: 64px; color: #c0c4cc; margin-bottom: 20px;">ğŸ“„</div>
            <h3 style="margin: 0 0 10px 0; color: #303133;">æš‚æ— æ–‡ç« </h3>
            <p style="margin: 0 0 20px 0; color: #909399;">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•æ–‡ç« </p>
            <a href="/admin/posts/create" style="padding: 8px 16px; background: #409eff; color: white; text-decoration: none; border-radius: 4px;">
                åˆ›å»ºç¬¬ä¸€ç¯‡æ–‡ç« 
            </a>
        </div>
        {% endif %}

        <!-- åˆ†é¡µ -->
        <div style="padding: 20px; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #606266; font-size: 14px;">
                å…± {{ posts.total }} æ¡è®°å½•
            </div>
            <div style="display: flex; gap: 5px;">
                {% if posts.has_prev %}
                <a href="?page={{ posts.prev_num }}{% if status %}&status={{ status }}{% endif %}{% if category_id %}&category_id={{ category_id }}{% endif %}" style="padding: 5px 10px; border: 1px solid #dcdfe6; border-radius: 4px; text-decoration: none; color: #606266;">ä¸Šä¸€é¡µ</a>
                {% endif %}
                
                <span style="padding: 5px 10px; background: #409eff; color: white; border-radius: 4px;">{{ posts.page }}</span>
                
                {% if posts.has_next %}
                <a href="?page={{ posts.next_num }}{% if status %}&status={{ status }}{% endif %}{% if category_id %}&category_id={{ category_id }}{% endif %}" style="padding: 5px 10px; border: 1px solid #dcdfe6; border-radius: 4px; text-decoration: none; color: #606266;">ä¸‹ä¸€é¡µ</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// çŠ¶æ€ç­›é€‰
document.getElementById('statusFilter').addEventListener('change', function() {
    const status = this.value;
    const url = new URL(window.location);
    if (status) {
        url.searchParams.set('status', status);
    } else {
        url.searchParams.delete('status');
    }
    url.searchParams.delete('page');
    window.location.href = url.toString();
});

// åˆ†ç±»ç­›é€‰
document.getElementById('categoryFilter').addEventListener('change', function() {
    const categoryId = this.value;
    const url = new URL(window.location);
    if (categoryId) {
        url.searchParams.set('category_id', categoryId);
    } else {
        url.searchParams.delete('category_id');
    }
    url.searchParams.delete('page');
    window.location.href = url.toString();
});

// åˆ é™¤æ–‡ç« 
function deletePost(postId, postTitle) {
    if (confirm('ç¡®å®šè¦åˆ é™¤æ–‡ç«  "' + postTitle + '" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/posts/' + postId + '/delete';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
