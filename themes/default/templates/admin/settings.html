{% extends "admin/base.html" %}

{% block admin_content %}
<div class="admin-settings">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #303133;">系统设置</h2>
        <div>
            <el-button type="primary" onclick="document.getElementById('settingsForm').submit()">
                <i class="el-icon-check"></i> 保存设置
            </el-button>
        </div>
    </div>

    <form method="POST" id="settingsForm" action="{{ url_for('admin.save_settings') }}">
        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
            <!-- 主要内容区 -->
            <div>
                <!-- 基本设置 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">基本设置</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">网站标题 <span style="color: #f56c6c;">*</span></label>
                        <div class="el-input">
                            <div class="el-input__wrapper">
                                <input class="el-input__inner" type="text" name="site_title" value="{{ settings.site_title if settings.site_title else '' }}" placeholder="请输入网站标题" required>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">网站描述</label>
                        <div class="el-textarea">
                            <textarea class="el-textarea__inner" name="site_description" rows="3" placeholder="请输入网站描述">{{ settings.site_description if settings.site_description else '' }}</textarea>
                        </div>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px;">用于SEO，建议150字符以内</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">网站关键词</label>
                        <div class="el-input">
                            <div class="el-input__wrapper">
                                <input class="el-input__inner" type="text" name="site_keywords" value="{{ settings.site_keywords if settings.site_keywords else '' }}" placeholder="多个关键词用逗号分隔">
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px;">用于SEO，多个关键词用英文逗号分隔</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">网站地址</label>
                        <div class="el-input">
                            <div class="el-input__wrapper">
                                <input class="el-input__inner" type="text" name="site_url" value="{{ settings.site_url if settings.site_url else '' }}" placeholder="https://example.com">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">管理员邮箱</label>
                        <div class="el-input">
                            <div class="el-input__wrapper">
                                <input class="el-input__inner" type="email" name="admin_email" value="{{ settings.admin_email if settings.admin_email else '' }}" placeholder="admin@example.com">
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">页脚内容</label>
                        <div class="el-textarea">
                            <textarea class="el-textarea__inner" name="footer_text" rows="6" placeholder="请输入页脚HTML内容" style="font-family: monospace;">{{ settings.footer_text if settings.footer_text else '' }}</textarea>
                        </div>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px;">
                            支持HTML格式。示例：<br>
                            <code style="background: #f5f7fa; padding: 2px 4px; border-radius: 3px;">&lt;p&gt;© 2025 我的博客&lt;/p&gt;</code><br>
                            <code style="background: #f5f7fa; padding: 2px 4px; border-radius: 3px;">&lt;p&gt;Powered by &lt;a href="https://github.com/streetartist/noteblog"&gt;Noteblog&lt;/a&gt;&lt;/p&gt;</code><br>
                            <code style="background: #f5f7fa; padding: 2px 4px; border-radius: 3px;">&lt;p&gt;&lt;a href="https://beian.miit.gov.cn/"&gt;沪ICP备XXXXXXXX号&lt;/a&gt;&lt;/p&gt;</code>
                        </div>
                    </div>
                </div>

                <!-- 显示设置 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">显示设置</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">每页文章数</label>
                        <div class="el-input" style="width: 200px;">
                            <div class="el-input__wrapper">
                                <input class="el-input__inner" type="number" name="posts_per_page" min="5" max="50" value="{{ settings.posts_per_page if settings.posts_per_page else 10 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">时区</label>
                        <div class="el-select" style="width: 200px;">
                            <div class="el-input el-input--suffix">
                                <div class="el-input__wrapper">
                                    <select name="timezone" class="el-input__inner" style="border: none; outline: none; width: 100%; background: transparent; -webkit-appearance: auto;">
                                        <option value="Asia/Shanghai" {% if settings.timezone == 'Asia/Shanghai' %}selected{% endif %}>北京时间 (UTC+8)</option>
                                        <option value="Asia/Tokyo" {% if settings.timezone == 'Asia/Tokyo' %}selected{% endif %}>东京时间 (UTC+9)</option>
                                        <option value="America/New_York" {% if settings.timezone == 'America/New_York' %}selected{% endif %}>纽约时间 (UTC-5)</option>
                                        <option value="Europe/London" {% if settings.timezone == 'Europe/London' %}selected{% endif %}>伦敦时间 (UTC+0)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">日期格式</label>
                        <div class="el-select" style="width: 200px;">
                            <div class="el-input el-input--suffix">
                                <div class="el-input__wrapper">
                                    <select name="date_format" class="el-input__inner" style="border: none; outline: none; width: 100%; background: transparent; -webkit-appearance: auto;">
                                        <option value="%Y-%m-%d" {% if settings.date_format == '%Y-%m-%d' %}selected{% endif %}>2024-01-01</option>
                                        <option value="%Y/%m/%d" {% if settings.date_format == '%Y/%m/%d' %}selected{% endif %}>2024/01/01</option>
                                        <option value="%m/%d/%Y" {% if settings.date_format == '%m/%d/%Y' %}selected{% endif %}>01/01/2024</option>
                                        <option value="%Y年%m月%d日" {% if settings.date_format == '%Y年%m月%d日' %}selected{% endif %}>2024年1月1日</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 评论设置 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">评论设置</h3>

                    <div style="margin-bottom: 15px;">
                        <label class="settings-checkbox" style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="comment_moderation" value="true" {% if settings.comment_moderation %}checked{% endif %} style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;">
                            <span style="color: #606266; font-size: 14px;">评论需要审核</span>
                        </label>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px; margin-left: 24px;">新评论需要管理员审核后才能显示</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label class="settings-checkbox" style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="comment_registration" value="true" {% if settings.comment_registration %}checked{% endif %} style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer;">
                            <span style="color: #606266; font-size: 14px;">仅注册用户可评论</span>
                        </label>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px; margin-left: 24px;">只有注册用户才能发表评论</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">评论审核关键词</label>
                        <div class="el-textarea">
                            <textarea class="el-textarea__inner" name="comment_blacklist" rows="3" placeholder="每行一个关键词">{{ settings.comment_blacklist if settings.comment_blacklist else '' }}</textarea>
                        </div>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px;">包含这些关键词的评论将自动标记为垃圾评论</div>
                    </div>
                </div>
            </div>

            <!-- 侧边栏 -->
            <div>
                <!-- 快速操作 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">快速操作</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <el-button type="primary" native-type="submit" style="width: 100%;">
                            <i class="el-icon-check"></i> 保存设置
                        </el-button>
                        <el-button @click="resetSettings" style="width: 100%;">
                            <i class="el-icon-refresh"></i> 重置设置
                        </el-button>
                        <el-button @click="exportSettings" style="width: 100%;">
                            <i class="el-icon-download"></i> 导出设置
                        </el-button>
                        <el-button @click="importSettings" style="width: 100%;">
                            <i class="el-icon-upload2"></i> 导入设置
                        </el-button>
                    </div>
                </div>

                <!-- 系统信息 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">系统信息</h3>
                    
                    <div style="font-size: 12px; color: #909399; line-height: 1.6;">
                        <div style="margin-bottom: 8px;">
                            <strong>Noteblog版本：</strong>1.0.0
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Python版本：</strong>3.8+
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Flask版本：</strong>2.0+
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>数据库：</strong>MySQL
                        </div>
                        <div>
                            <strong>最后更新：</strong>{{ settings.updated_at if settings.updated_at else '刚刚' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </form>

            <!-- 备份与恢复 -->
            <div style="margin-top: 30px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 16px 0; color: #303133; font-size: 16px;">备份与恢复</h3>
                <p style="margin: 0 0 16px 0; color: #909399; font-size: 13px;">备份文件包含 uploads 目录与 SQLite 格式的数据库，可以在任意数据库类型中恢复。</p>
                
                <!-- 下载备份 -->
                <div style="padding: 16px; background: #f0f9eb; border-radius: 6px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <strong style="color: #67c23a;">下载备份</strong>
                            <div style="margin-top: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="includeExtensionsCheck" checked style="margin-right: 8px;">
                                    <span style="font-size: 14px; color: #606266;">包含插件和主题文件</span>
                                </label>
                            </div>
                        </div>
                        <a id="downloadBackupBtn" class="el-button el-button--success" style="text-decoration: none; color: white; background: #67c23a; border-color: #67c23a;" href="{{ url_for('admin.download_backup') }}?include_extensions=true">
                            <i class="el-icon-download"></i> 立即下载备份
                        </a>
                    </div>
                </div>

                <!-- 导入备份 -->
                <div style="padding: 16px; background: #fdf6ec; border-radius: 6px;">
                    <strong style="color: #e6a23c;">导入备份</strong>
                    <form action="{{ url_for('admin.import_backup') }}" method="POST" enctype="multipart/form-data" style="margin-top: 12px;">
                        <!-- 隐藏字段确保值被发送 -->
                        <input type="hidden" name="restore_extensions" id="restoreExtensionsHidden" value="true">
                        <input type="hidden" name="overwrite_extensions" id="overwriteExtensionsHidden" value="true">
                        
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <input type="file" name="backup_file" accept=".zip" required style="flex: 1; min-width: 240px; padding: 6px 10px; border: 1px solid #dcdfe6; border-radius: 4px; background: white;" />
                            <button type="submit" class="el-button el-button--warning" style="border: none; cursor: pointer; background: #e6a23c; color: white; padding: 10px 20px; border-radius: 4px;">
                                <i class="el-icon-upload2"></i> 导入备份
                            </button>
                        </div>
                        <div style="display: flex; gap: 20px; margin-top: 12px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="restoreExtensionsCheck" checked style="margin-right: 8px;">
                                <span style="font-size: 14px; color: #606266;">恢复插件和主题文件</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="overwriteExtensionsCheck" checked style="margin-right: 8px;">
                                <span style="font-size: 14px; color: #606266;">覆盖同名插件和主题文件</span>
                            </label>
                        </div>
                    </form>
                    <p style="margin: 10px 0 0; font-size: 12px; color: #f56c6c;">⚠️ 导入备份会覆盖当前数据库及上传文件，操作前请务必确认。</p>
                </div>
            </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
    // 下载备份：控制是否包含插件和主题
    var includeCheck = document.getElementById('includeExtensionsCheck');
    var downloadBtn = document.getElementById('downloadBackupBtn');
    
    function updateDownloadUrl() {
        var baseUrl = '{{ url_for("admin.download_backup") }}';
        if (includeCheck.checked) {
            downloadBtn.href = baseUrl + '?include_extensions=true';
        } else {
            downloadBtn.href = baseUrl;
        }
    }
    
    includeCheck.addEventListener('change', updateDownloadUrl);
    updateDownloadUrl();
    
    // 导入备份：控制隐藏字段的值
    var restoreCheck = document.getElementById('restoreExtensionsCheck');
    var restoreHidden = document.getElementById('restoreExtensionsHidden');
    var overwriteCheck = document.getElementById('overwriteExtensionsCheck');
    var overwriteHidden = document.getElementById('overwriteExtensionsHidden');
    
    restoreCheck.addEventListener('change', function() {
        restoreHidden.value = restoreCheck.checked ? 'true' : 'false';
    });
    
    overwriteCheck.addEventListener('change', function() {
        overwriteHidden.value = overwriteCheck.checked ? 'true' : 'false';
    });
})();
</script>
{% endblock %}
