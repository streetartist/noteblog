{% extends "admin/base.html" %}

{% block admin_content %}
<div id="comments-app">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #303133;">è¯„è®ºç®¡ç†</h2>
        <form action="{{ url_for('admin.toggle_global_comments') }}" method="post" style="display: inline;">
            <input type="hidden" name="enabled" value="{{ 'false' if allow_comments else 'true' }}">
            <button type="submit" style="padding: 8px 16px; background: {{ '#f56c6c' if allow_comments else '#67c23a' }}; color: white; border: none; border-radius: 4px; cursor: pointer;">
                {{ 'å…³é—­æ‰€æœ‰è¯„è®º' if allow_comments else 'å¼€å¯æ‰€æœ‰è¯„è®º' }}
            </button>
        </form>
    </div>

    <!-- ç­›é€‰å™¨ -->
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="color: #606266; font-size: 14px;">çŠ¶æ€ç­›é€‰ï¼š</label>
                <select id="statusFilter" style="padding: 8px; border: 1px solid #dcdfe6; border-radius: 4px;">
                    <option value="">å…¨éƒ¨</option>
                    <option value="approved" {% if status == 'approved' %}selected{% endif %}>å·²é€šè¿‡</option>
                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>å¾…å®¡æ ¸</option>
                    <option value="spam" {% if status == 'spam' %}selected{% endif %}>åƒåœ¾</option>
                </select>
            </div>
        </div>
    </div>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead style="background: #f5f7fa;">
                <tr>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5;">è¯„è®ºå†…å®¹</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5; width: 180px;">é‚®ç®±</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5; width: 120px;">IPåœ°å€</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5; width: 100px;">çŠ¶æ€</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ebeef5; width: 200px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for comment in comments.items %}
                <tr style="border-bottom: 1px solid #ebeef5;">
                    <td style="padding: 12px;">
                        <div style="line-height: 1.5;">
                            <div style="font-weight: 500; color: #303133; margin-bottom: 4px;">
                                {{ comment.get_display_name() }}
                            </div>
                            <div style="color: #606266; font-size: 14px; margin-bottom: 8px;">
                                {{ comment.content[:150] }}{% if comment.content|length > 150 %}...{% endif %}
                            </div>
                            <div style="font-size: 12px; color: #909399;">
                                <span>æ–‡ç« ï¼š{{ comment.post.title if comment.post else 'å·²åˆ é™¤' }}</span>
                                <span style="margin-left: 10px;">{{ comment.created_at|localtime('%Y-%m-%d %H:%M') if comment.created_at else '' }}</span>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 12px; color: #606266; font-size: 13px;">
                        {{ comment.get_display_email() }}
                    </td>
                    <td style="padding: 12px; color: #606266; font-size: 13px;">
                        {{ comment.author_ip or '-' }}
                    </td>
                    <td style="padding: 12px;">
                        {% if comment.is_approved %}
                        <span style="padding: 4px 8px; background: #f0f9ff; color: #67c23a; border-radius: 4px; font-size: 12px;">å·²é€šè¿‡</span>
                        {% elif comment.is_spam %}
                        <span style="padding: 4px 8px; background: #fef0f0; color: #f56c6c; border-radius: 4px; font-size: 12px;">åƒåœ¾</span>
                        {% else %}
                        <span style="padding: 4px 8px; background: #fdf6ec; color: #e6a23c; border-radius: 4px; font-size: 12px;">å¾…å®¡æ ¸</span>
                        {% endif %}
                    </td>
                    <td style="padding: 12px;">
                        {% if not comment.is_approved and not comment.is_spam %}
                        <button onclick="approveComment({{ comment.id }})" style="padding: 5px 10px; background: #67c23a; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                            é€šè¿‡
                        </button>
                        {% endif %}
                        {% if not comment.is_spam %}
                        <button onclick="markSpam({{ comment.id }})" style="padding: 5px 10px; background: #e6a23c; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                            åƒåœ¾
                        </button>
                        {% endif %}
                        <button onclick="deleteComment({{ comment.id }})" style="padding: 5px 10px; background: #f56c6c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            åˆ é™¤
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if not comments.items %}
        <div style="text-align: center; padding: 60px;">
            <div style="font-size: 64px; color: #c0c4cc; margin-bottom: 20px;">ğŸ’¬</div>
            <h3 style="margin: 0 0 10px 0; color: #303133;">æš‚æ— è¯„è®º</h3>
            <p style="margin: 0; color: #909399;">è¿˜æ²¡æœ‰ç”¨æˆ·å‘è¡¨è¯„è®º</p>
        </div>
        {% endif %}

        <!-- åˆ†é¡µ -->
        <div style="padding: 20px; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #606266; font-size: 14px;">
                å…± {{ comments.total }} æ¡è®°å½•
            </div>
            <div style="display: flex; gap: 5px;">
                {% if comments.has_prev %}
                <a href="?page={{ comments.prev_num }}{% if status %}&status={{ status }}{% endif %}" style="padding: 5px 10px; border: 1px solid #dcdfe6; border-radius: 4px; text-decoration: none; color: #606266;">ä¸Šä¸€é¡µ</a>
                {% endif %}
                
                <span style="padding: 5px 10px; background: #409eff; color: white; border-radius: 4px;">{{ comments.page }}</span>
                
                {% if comments.has_next %}
                <a href="?page={{ comments.next_num }}{% if status %}&status={{ status }}{% endif %}" style="padding: 5px 10px; border: 1px solid #dcdfe6; border-radius: 4px; text-decoration: none; color: #606266;">ä¸‹ä¸€é¡µ</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            const status = this.value;
            const url = new URL(window.location);
            if (status) {
                url.searchParams.set('status', status);
            } else {
                url.searchParams.delete('status');
            }
            url.searchParams.delete('page');
            window.location.href = url.toString();
        });
    }
});

function approveComment(commentId) {
    if (confirm('ç¡®å®šè¦é€šè¿‡æ­¤è¯„è®ºå—ï¼Ÿ')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/comments/' + commentId + '/approve';
        document.body.appendChild(form);
        form.submit();
    }
}

function markSpam(commentId) {
    if (confirm('ç¡®å®šè¦æ ‡è®°æ­¤è¯„è®ºä¸ºåƒåœ¾è¯„è®ºå—ï¼Ÿ')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/comments/' + commentId + '/spam';
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteComment(commentId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/comments/' + commentId + '/delete';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
