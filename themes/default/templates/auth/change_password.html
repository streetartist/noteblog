{% extends "base.html" %}

{% block title %}{{ page_title or ('修改密码 - ' ~ (site_title or 'Noteblog')) }}{% endblock %}

{% block content %}
<div class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h2>修改密码</h2>
                <p>为了账户安全，请定期更新您的密码</p>
            </div>
            
            <form method="POST" class="auth-form" id="change-password-form">
                <!-- Flash messages will be handled by theme manager -->
                
                <div class="form-group">
                    <el-form-item label="当前密码" required>
                        <el-input
                            name="current_password"
                            type="password"
                            placeholder="请输入当前密码"
                            show-password
                            required>
                        </el-input>
                    </el-form-item>
                </div>
                
                <div class="form-group">
                    <el-form-item label="新密码" required>
                        <el-input
                            name="new_password"
                            type="password"
                            placeholder="请输入新密码（至少6位）"
                            show-password
                            required
                            @input="checkPasswordStrength">
                        </el-input>
                        <div class="password-strength" id="password-strength" style="display: none;">
                            <div class="strength-label">密码强度：</div>
                            <div class="strength-bar">
                                <div class="strength-fill" id="strength-fill"></div>
                            </div>
                            <div class="strength-text" id="strength-text"></div>
                        </div>
                    </el-form-item>
                </div>
                
                <div class="form-group">
                    <el-form-item label="确认新密码" required>
                        <el-input
                            name="confirm_password"
                            type="password"
                            placeholder="请再次输入新密码"
                            show-password
                            required
                            @input="checkPasswordMatch">
                        </el-input>
                        <div class="password-match" id="password-match" style="display: none;">
                            <span id="match-text"></span>
                        </div>
                    </el-form-item>
                </div>
                
                <div class="password-tips">
                    <h4>密码要求：</h4>
                    <ul>
                        <li id="length-check" class="check-item">
                            <i class="el-icon-circle-check"></i>
                            <span>至少6个字符</span>
                        </li>
                        <li id="complexity-check" class="check-item">
                            <i class="el-icon-circle-check"></i>
                            <span>包含字母和数字</span>
                        </li>
                    </ul>
                </div>
                
                <div class="form-actions">
                    <el-button @click="goBack">取消</el-button>
                    <el-button type="primary" native-type="submit" id="submit-btn">修改密码</el-button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.auth-page {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
}

.auth-container {
    width: 100%;
    max-width: 450px;
}

.auth-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    padding: 40px;
}

.auth-header {
    text-align: center;
    margin-bottom: 30px;
}

.auth-header h2 {
    color: #303133;
    margin-bottom: 10px;
    font-size: 24px;
}

.auth-header p {
    color: #909399;
    margin: 0;
    font-size: 14px;
}

.auth-form {
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 25px;
}

.form-actions {
    margin-top: 30px;
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.password-strength {
    margin-top: 10px;
    padding: 10px;
    background: #f5f7fa;
    border-radius: 4px;
    font-size: 12px;
}

.strength-label {
    margin-bottom: 5px;
    color: #606266;
}

.strength-bar {
    width: 100%;
    height: 4px;
    background: #ebeef5;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 5px;
}

.strength-fill {
    height: 100%;
    transition: width 0.3s ease, background-color 0.3s ease;
    width: 0%;
}

.strength-fill.weak {
    width: 33%;
    background-color: #f56c6c;
}

.strength-fill.medium {
    width: 66%;
    background-color: #e6a23c;
}

.strength-fill.strong {
    width: 100%;
    background-color: #67c23a;
}

.strength-text {
    color: #606266;
}

.password-match {
    margin-top: 8px;
    font-size: 12px;
}

.password-match.match {
    color: #67c23a;
}

.password-match.mismatch {
    color: #f56c6c;
}

.password-tips {
    background: #f0f9ff;
    border: 1px solid #b3d8ff;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
}

.password-tips h4 {
    margin: 0 0 10px 0;
    color: #409eff;
    font-size: 14px;
}

.password-tips ul {
    margin: 0;
    padding-left: 20px;
    list-style: none;
}

.check-item {
    margin-bottom: 5px;
    color: #909399;
    display: flex;
    align-items: center;
    gap: 8px;
}

.check-item.valid {
    color: #67c23a;
}

.check-item i {
    font-size: 14px;
}

.check-item.valid i {
    color: #67c23a;
}

.check-item:not(.valid) i {
    color: #dcdfe6;
}

/* 响应式设计 */
@media (max-width: 480px) {
    .auth-card {
        padding: 20px;
    }
    
    .auth-header h2 {
        font-size: 20px;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions .el-button {
        width: 100%;
    }
}
</style>

<script>
// 密码强度检查
function checkPasswordStrength(password) {
    let strength = 0;
    const checks = {
        length: password.length >= 6,
        complexity: /[a-zA-Z]/.test(password) && /[0-9]/.test(password)
    };
    
    if (checks.length) strength++;
    if (checks.complexity) strength++;
    
    return { strength, checks };
}

// 更新密码强度显示
function updatePasswordStrength(password) {
    const result = checkPasswordStrength(password);
    const strengthDiv = document.getElementById('password-strength');
    const strengthFill = document.getElementById('strength-fill');
    const strengthText = document.getElementById('strength-text');
    
    if (password.length > 0) {
        strengthDiv.style.display = 'block';
        
        // 更新强度条
        strengthFill.className = 'strength-fill';
        if (result.strength === 1) {
            strengthFill.classList.add('weak');
            strengthText.textContent = '弱';
        } else if (result.strength === 2) {
            strengthFill.classList.add('medium');
            strengthText.textContent = '中等';
        } else {
            strengthFill.classList.add('strong');
            strengthText.textContent = '强';
        }
    } else {
        strengthDiv.style.display = 'none';
    }
    
    // 更新检查项
    const lengthCheck = document.getElementById('length-check');
    const complexityCheck = document.getElementById('complexity-check');
    
    if (result.checks.length) {
        lengthCheck.classList.add('valid');
    } else {
        lengthCheck.classList.remove('valid');
    }
    
    if (result.checks.complexity) {
        complexityCheck.classList.add('valid');
    } else {
        complexityCheck.classList.remove('valid');
    }
}

// 检查密码匹配
function checkPasswordMatch() {
    const newPassword = document.querySelector('input[name="new_password"]').value;
    const confirmPassword = document.querySelector('input[name="confirm_password"]').value;
    const matchDiv = document.getElementById('password-match');
    const matchText = document.getElementById('match-text');
    
    if (confirmPassword.length > 0) {
        matchDiv.style.display = 'block';
        if (newPassword === confirmPassword) {
            matchDiv.className = 'password-match match';
            matchText.textContent = '密码匹配';
        } else {
            matchDiv.className = 'password-match mismatch';
            matchText.textContent = '密码不匹配';
        }
    } else {
        matchDiv.style.display = 'none';
    }
}

// Vue 应用方法
if (window._noteblog_app) {
    const app = window._noteblog_app;
    
    app.config.globalProperties.checkPasswordStrength = function(password) {
        updatePasswordStrength(password);
    };
    
    app.config.globalProperties.checkPasswordMatch = function() {
        checkPasswordMatch();
    };
    
    app.config.globalProperties.goBack = function() {
        window.history.back();
    };
}

// 表单验证
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('change-password-form');
    
    form.addEventListener('submit', function(e) {
        const currentPassword = form.querySelector('input[name="current_password"]').value;
        const newPassword = form.querySelector('input[name="new_password"]').value;
        const confirmPassword = form.querySelector('input[name="confirm_password"]').value;
        
        // 验证当前密码
        if (!currentPassword) {
            e.preventDefault();
            alert('请输入当前密码');
            return false;
        }
        
        // 验证新密码长度
        if (newPassword.length < 6) {
            e.preventDefault();
            alert('新密码长度至少为6位');
            return false;
        }
        
        // 验证密码匹配
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('两次输入的新密码不一致');
            return false;
        }
        
        // 验证新密码不能与当前密码相同
        if (currentPassword === newPassword) {
            e.preventDefault();
            alert('新密码不能与当前密码相同');
            return false;
        }
        
        // 确认提交
        if (!confirm('确定要修改密码吗？')) {
            e.preventDefault();
            return false;
        }
    });
    
    // 监听密码输入变化
    const newPasswordInput = form.querySelector('input[name="new_password"]');
    const confirmPasswordInput = form.querySelector('input[name="confirm_password"]');
    
    newPasswordInput.addEventListener('input', function() {
        updatePasswordStrength(this.value);
        if (confirmPasswordInput.value) {
            checkPasswordMatch();
        }
    });
    
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
});
</script>
{% endblock %}
