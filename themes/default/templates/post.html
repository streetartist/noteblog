{% extends "base.html" %}

{% block title %}{{ page_title or (post.title ~ ' - ' ~ (site_title or 'Noteblog')) }}{% endblock %}
{% block description %}{{ post.excerpt or post.content[:150] }}{% endblock %}
{% block keywords %}{{ post.seo_keywords or post.tags|map(attribute='name')|join(', ') }}{% endblock %}

{% block content %}
<article class="post-detail">
    <header class="post-header">
        <h1 class="post-title">{{ post.title }}</h1>
        {% set published_time = post.published_at or post.created_at %}
        
        <div class="post-meta">
            <span class="post-author">
                <el-avatar :size="30" src="{{ post.author.avatar }}">
                    {{ post.author.display_name or post.author.username }}
                </el-avatar>
                <span class="author-name">{{ post.author.display_name or post.author.username }}</span>
            </span>
            <span class="post-date">
                <i class="el-icon-time"></i>
                发布于 {{ published_time.strftime('%Y-%m-%d %H:%M:%S') if published_time else '' }}
            </span>
            {% if post.category %}
            <span class="post-category">
                <i class="el-icon-folder"></i>
                <a href="/category/{{ post.category.slug }}">{{ post.category.name }}</a>
            </span>
            {% endif %}
            <span class="post-views">
                <i class="el-icon-view"></i>
                {{ post.view_count }} 阅读
            </span>
            <span class="post-comments">
                <i class="el-icon-chat-dot-round"></i>
                {{ post.comment_count }} 评论
            </span>
        </div>

    <!-- 插件钩子：文章元信息（插件可在此插入额外元信息/按钮） -->
    {% if plugin_hooks and plugin_hooks.post_meta %}
        {% for hook_content in plugin_hooks.post_meta %}
            {{ hook_content|safe }}
        {% endfor %}
    {% endif %}
        
        {% if post.tags %}
        <div class="post-tags">
            {% for tag in post.tags %}
            <el-tag size="small" style="margin: 2px;">
                <a href="/tag/{{ tag.slug }}">{{ tag.name }}</a>
            </el-tag>
            {% endfor %}
        </div>
        {% endif %}
    </header>
    
    {% if post.featured_image %}
    <div class="post-featured-image">
        <img src="{{ post.featured_image }}" alt="{{ post.title }}" loading="lazy">
    </div>
    {% endif %}
    
    <div class="post-content">
        {{ post.get_content_html()|safe }}
    </div>
    
    <footer class="post-footer">
        <div class="post-actions">
            <el-button type="primary" @click="likePost">
                <i class="el-icon-thumb"></i>
                点赞 ({{ post.like_count }})
            </el-button>
            <el-button @click="sharePost">
                <i class="el-icon-share"></i>
                分享
            </el-button>
        </div>
        
        <div class="post-navigation">
            {% if prev_post and prev_post.slug %}
            <div class="nav-prev">
                <el-link :underline="false" href="/post/{{ prev_post.slug }}">
                    <i class="el-icon-arrow-left"></i>
                    {{ prev_post.title }}
                </el-link>
            </div>
            {% endif %}
            {% if next_post and next_post.slug %}
            <div class="nav-next">
                <el-link :underline="false" href="/post/{{ next_post.slug }}">
                    {{ next_post.title }}
                    <i class="el-icon-arrow-right"></i>
                </el-link>
            </div>
            {% endif %}
        </div>
    </footer>

    <!-- 插件钩子：文章底部（如社交按钮、扩展操作等） -->
    {% if plugin_hooks and plugin_hooks.post_footer %}
        {% for hook_content in plugin_hooks.post_footer %}
            {{ hook_content|safe }}
        {% endfor %}
    {% endif %}
</article>

<!-- 评论区 -->
<section class="comments-section">
    <h3 class="comments-title">评论 ({{ post.comment_count }})</h3>
    
    {% if post.comment_status == 'open' %}
    <!-- 评论表单 -->
    <!-- 插件钩子：评论表单上方 -->
    {% if plugin_hooks and plugin_hooks.comment_form_top %}
        {% for hook_content in plugin_hooks.comment_form_top %}
            {{ hook_content|safe }}
        {% endfor %}
    {% endif %}
    <div class="comment-form">
        <h4>发表评论</h4>
        <!-- 隐藏的post_id字段 -->
        <input type="hidden" name="post_id" value="{{ post.id }}">
        <el-form :model="commentForm" label-width="80px">
            {% if not current_user.is_authenticated %}
            <el-form-item label="姓名">
                <el-input v-model="commentForm.author_name" placeholder="请输入姓名"></el-input>
            </el-form-item>
            <el-form-item label="邮箱">
                <el-input v-model="commentForm.author_email" placeholder="请输入邮箱"></el-input>
            </el-form-item>
            <el-form-item label="网站">
                <el-input v-model="commentForm.author_website" placeholder="请输入网站（可选）"></el-input>
            </el-form-item>
            {% endif %}
            <el-form-item label="评论">
                <el-input
                    type="textarea"
                    v-model="commentForm.content"
                    :rows="4"
                    placeholder="请输入评论内容，支持Markdown格式">
                </el-input>
                <div style="font-size: 12px; color: #909399; margin-top: 4px;">
                    支持Markdown语法：**粗体** *斜体* `代码` [链接](url) >引用
                </div>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="submitComment({{ post.id }})">发表评论</el-button>
            </el-form-item>
        </el-form>
    </div>
    <!-- 插件钩子：评论表单下方 -->
    {% if plugin_hooks and plugin_hooks.comment_form_bottom %}
        {% for hook_content in plugin_hooks.comment_form_bottom %}
            {{ hook_content|safe }}
        {% endfor %}
    {% endif %}
    {% else %}
    <el-alert
        title="评论已关闭"
        type="info"
        :closable="false"
        show-icon>
    </el-alert>
    {% endif %}
    
    <!-- 评论列表 -->
    <div class="comments-list">
        {% if comments %}
            {% for comment in comments %}
            <div class="comment-item" :class="{ 'comment-reply': {{ (comment.parent_id is not none)|tojson }} }">
                <div class="comment-avatar">
                    <el-avatar :size="40" src="{{ comment.get_display_avatar() or '' }}">
                        {{ comment.get_display_name() }}
                    </el-avatar>
                </div>
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">{{ comment.get_display_name() }}</span>
                        <span class="comment-date">{{ comment.created_at.strftime('%Y-%m-%d %H:%M:%S') if comment.created_at else '' }}</span>
                        {% if comment.get_display_website() %}
                        <a href="{{ comment.get_display_website() }}" target="_blank" class="comment-website">
                            <i class="el-icon-link"></i>
                        </a>
                        {% endif %}
                    </div>
                    <div class="comment-text">{{ comment.get_content_html()|safe }}</div>
                    <div class="comment-actions">
                        <el-button size="small" text @click='replyComment({{ comment.id }}, {{ comment.get_display_name()|tojson }})'>
                            回复
                        </el-button>
                    </div>
                    
                    <!-- 回复表单 -->
                    <div v-if="replyForm.parentId === {{ comment.id }}" class="reply-form">
                        <el-form :model="replyForm" label-width="60px">
                            {% if not current_user.is_authenticated %}
                            <el-form-item label="姓名">
                                <el-input v-model="replyForm.author_name" size="small"></el-input>
                            </el-form-item>
                            <el-form-item label="邮箱">
                                <el-input v-model="replyForm.author_email" size="small"></el-input>
                            </el-form-item>
                            {% endif %}
                            <el-form-item label="回复">
                                <el-input
                                    type="textarea"
                                    v-model="replyForm.content"
                                    :rows="3"
                                    size="small"
                                    placeholder="回复 {{ comment.get_display_name() }}，支持Markdown格式">
                                </el-input>
                                <div style="font-size: 12px; color: #909399; margin-top: 4px;">
                                    支持Markdown语法：**粗体** *斜体* `代码` [链接](url) >引用
                                </div>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" size="small" @click="submitReply({{ post.id }})">回复</el-button>
                                <el-button size="small" @click="cancelReply">取消</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                    
                    <!-- 子评论 -->
                    {% for reply in comment.get_replies() %}
                    <div class="comment-item comment-reply">
                        <div class="comment-avatar">
                            <el-avatar :size="32" src="{{ reply.get_display_avatar() or '' }}">
                                {{ reply.get_display_name() }}
                            </el-avatar>
                        </div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">{{ reply.get_display_name() }}</span>
                                <span class="comment-date">{{ reply.created_at.strftime('%Y-%m-%d %H:%M:%S') if reply.created_at else '' }}</span>
                            </div>
                            <div class="comment-text">
                                <span class="reply-to">@{{ comment.get_display_name() }}:</span>
                                {{ reply.get_content_html()|safe }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% else %}
        <el-empty description="暂无评论" :image-size="100"></el-empty>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<!-- 使用 base.html 中的全局 Vue 应用提供的交互方法 -->
{% endblock %}
